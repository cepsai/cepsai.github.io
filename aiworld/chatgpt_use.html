<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Treemap with Slim Pill Legend</title>
<style>
.knitr .inline { background-color: #F7F7F7; border: solid 1px #B0B0B0; }
.error { font-weight: bold; color: #FF0000; }
.warning { font-weight: bold; }
.message { font-style: italic; }
.source, .output, .warning, .error, .message { padding: 0 1em; border: solid 1px #F7F7F7; }
.source { background-color: #F5F5F5; }
.rimage .left { text-align: left; }
.rimage .right { text-align: right; }
.rimage .center { text-align: center; }
.hl.num { color: #AF0F91; }
.hl.str { color: #317ECC; }
.hl.com { color: #AD95AF; font-style: italic; }
.hl.opt { color: #000000; }
.hl.std { color: #585858; }
.hl.kwa { color: #295F94; font-weight: bold; }
.hl.kwb { color: #B05A65; }
.hl.kwc { color: #55AA55; }
.hl.kwd { color: #BC5A65; font-weight: bold; }

/* ===== Layout & footer height that the treemap respects ===== */
:root { --legendHeight: clamp(80px, 12vh, 120px); }
body { margin: 0; overflow: hidden; }
#treemap { position: absolute; top: 0; left: 0; right: 0; bottom: var(--legendHeight); }

.logo { position: absolute; bottom: clamp(6px, 4vh, 20px); right: 20px; width: clamp(80px, 10vw, 200px); pointer-events: auto; z-index: 1000; opacity: 1; transition: opacity 0.3s ease; }
.logo.overlapped { opacity: 0.15; }
.logo.overlapped:hover { opacity: 1; }

.source-text { position: absolute; bottom: clamp(10px, 4vh, 30px); left: 20px; pointer-events: auto; font-size: clamp(12px, 1.5vw, 20px); font-weight: bold; color: #555555; z-index: 1000; opacity: 1; font-style: italic; transition: opacity 0.3s ease; }
.source-text.overlapped { opacity: 0.15; }
.source-text.overlapped:hover { opacity: 1; }

/* Footer container aligns legend centrally and adapts to width */
.controls-section {
  position: absolute; left: 0; right: 0; bottom: 0;
  height: var(--legendHeight);
  display: flex; align-items: center; justify-content: center;
  pointer-events: none; /* children opt-in */
}

/* ===== Slim Pill Legend ===== */
.custom-legend {
  position: relative; pointer-events: auto;
  display: flex; flex-wrap: wrap; align-items: center;
  gap: 8px 10px; padding: 10px 12px;
  border-radius: 14px;
  backdrop-filter: blur(6px);
  background: rgba(255,255,255,.86);
  box-shadow: 0 6px 22px rgba(0,0,0,.08);
  font: 500 clamp(12px,1.4vw,14px)/1.1 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  color: #3a3a3a;
  z-index: 1000;
  max-width: min(92vw, 1100px); /* adapts with treemap width */
}
.legend-pills { display: flex; flex-wrap: wrap; gap: 8px 10px; }
.legend-pill {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 7px 10px; border-radius: 999px; cursor: pointer;
  background: #fff; border: 1px solid rgba(0,0,0,.07);
  transition: transform .08s ease, opacity .2s ease, background .2s ease;
}
.legend-pill:hover { transform: translateY(-1px); }
.legend-pill.inactive { opacity: .35; }
.legend-dot {
  width: 12px; height: 12px; border-radius: 50%;
  box-shadow: 0 0 0 1px rgba(0,0,0,.15) inset;
}
.legend-label { font-weight: 560; }
.legend-val { opacity: .7; font-variant-numeric: tabular-nums; }


/* Wider legend container */
.controls-section {
  padding: 0 10px; /* small side padding so it can stretch */
}

.custom-legend {
  max-width: min(96vw, 1400px);   /* was 92vw/1100px */
  white-space: nowrap;            /* force one line */
  overflow-x: auto;               /* allow gentle scroll if it *just* overflows */
  gap: 6px 8px;                   /* tighter spacing */
  padding: 8px 10px;              /* slimmer padding */
  border-radius: 16px;            /* slightly wider look */
}

/* Smaller pills */
.legend-pills { gap: 6px 8px; }

.legend-pill {
  padding: 5px 8px;               /* was 7px 10px */
  border-radius: 999px;
  font: 500 clamp(11px, 1.1vw, 13px)/1.1 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
}

/* Smaller dot and tighter text */
.legend-dot { width: 10px; height: 10px; }

.legend-label { font-weight: 560; }
.legend-val {
  opacity: .7;
  font-variant-numeric: tabular-nums;
  margin-left: 2px;
}

/* Optional: on narrower viewports, hide % to keep one line */
@media (max-width: 980px) {
  .legend-val { display: none; }
}

/* Optional: hide scrollbar aesthetics on WebKit while keeping scrollability */
.custom-legend::-webkit-scrollbar { height: 6px; }
.custom-legend::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,.12);
  border-radius: 6px;
}




</style>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3plus-hierarchy@1"></script>
</head>
<body>

<div class="treemap-section">
  <div id="treemap"></div>
</div>

<div class="controls-section">
  <div class="custom-legend" id="legend"></div>
</div>

<script>
// ===================== YOUR DATA (as provided) =====================
var originalData = 
[
  { "id": "Generate Or Retrieve Other Media", "parent": "Multimedia", "color": "#98c8e3", "value": 1.1 },
  { "id": "Create An Image", "parent": "Multimedia", "color": "#b7d6ea", "value": 4.2 },
  { "id": "Analyze An Image", "parent": "Multimedia", "color": "#c2ddec", "value": 0.6 },

  { "id": "Other / Unknown", "parent": "Other / Unknown", "color": "#fdae6b", "value": 4.1 },
  { "id": "Asking About The Model", "parent": "Other / Unknown", "color": "#fd8d3c", "value": 0.4 },

  { "id": "Tutoring Or Teaching", "parent": "Practical Guidance", "color": "#52c167", "value": 10.2 },
  { "id": "How To Advice", "parent": "Practical Guidance", "color": "#88d291", "value": 8.5 },
  { "id": "Health, Fitness, Beauty Or Self Care", "parent": "Practical Guidance", "color": "#8cd698", "value": 5.7 },
  { "id": "Creative Ideation", "parent": "Practical Guidance", "color": "#b2e0b9", "value": 3.9 },

  { "id": "Specific Info", "parent": "Seeking Information", "color": "#f56f75", "value": 18.3 },
  { "id": "Purchasable Products", "parent": "Seeking Information", "color": "#f68d90", "value": 2.1 },
  { "id": "Cooking And Recipes", "parent": "Seeking Information", "color": "#b98e90", "value": 0.9 },

  { "id": "Relationships And Personal Reflection", "parent": "Self-Expression", "color": "#f0e7f4", "value": 1.9 },
  { "id": "Greetings And Chitchat", "parent": "Self-Expression", "color": "#f4eef7", "value": 2.0 },
  { "id": "Games And Role Play", "parent": "Self-Expression", "color": "#b6b2b8", "value": 0.4 },

  { "id": "Mathematical Calculation", "parent": "Technical Help", "color": "#967c79", "value": 3.0 },
  { "id": "Data Analysis", "parent": "Technical Help", "color": "#e6d4d1", "value": 0.4 },
  { "id": "Computer Programming", "parent": "Technical Help", "color": "#e6d4d1", "value": 4.2 },

  { "id": "Write Fiction", "parent": "Writing", "color": "#da8ec0", "value": 1.4 },
  { "id": "Translation", "parent": "Writing", "color": "#fbb0e0", "value": 4.5 },
  { "id": "Personal Writing Or Communication", "parent": "Writing", "color": "#fbcce9", "value": 8.0 },
  { "id": "Edit Or Critique Provided Text", "parent": "Writing", "color": "#fbcce9", "value": 10.6 },
  { "id": "Argument Or Summary Generation", "parent": "Writing", "color": "#fde1f2", "value": 3.6 }
];

// ===================== UTILITIES & NORMALIZATION =====================
function normalizeData(arr){
  return arr.map(function(d){
    var parent = d.parent || d.group || d.domain || d.category || d.type || d.class;
    var name = d.name || d.id || d.label || d.title;
    var value = (d.value != null) ? +d.value : (d.count != null) ? +d.count : (d.size != null) ? +d.size : 0;
    return { parent: parent, name: name, value: value };
  });
}
var data = normalizeData(originalData);
var groups = Array.from(new Set(data.map(function(d){ return d.parent; })));

var inferredColors = {};
groups.forEach(function(g){
  var item = originalData.find(function(x){
    var p = x.parent || x.group || x.domain || x.category || x.type || x.class;
    return p === g;
  });
  inferredColors[g] = item && item.color ? item.color : null;
});
var fallbackPalette = ["#1F77B4","#FF7F0E","#2CA02C","#9467BD","#D62728","#17BECF","#8C564B","#E377C2","#7F7F7F","#BCBD22"];
var groupColors = {};
groups.forEach(function(g, i){ groupColors[g] = inferredColors[g] || fallbackPalette[i % fallbackPalette.length]; });
var activeGroups = new Set(groups);
function getGroupColor(parent){ return groupColors[parent] || "#666666"; }

// ===================== TREEMAP =====================
var treemap = new d3plus.Treemap()
  .select("#treemap")
  .data(data)
  .groupBy(["parent","name"])
  .tooltipConfig({
    title:function(d){ return d.name; },
    body:function(d){
      var base = "<strong>Class:</strong> " + (d.parent || d.id) + "<br><strong>Count:</strong> " + (d.value || 0);
      return base;
    }
  })
  .sum("value")
  .layoutPadding(2)
  .legend(false)
  .color(function(d){ return getGroupColor(d.parent || d.id); })
  .shapeConfig({
    stroke:function(d){ if(d.depth===0){ return getGroupColor(d.id); } return "transparent"; },
    strokeWidth:function(d){ if(d.depth===0){ return 3; } return 0; },
    rx: 8,
    ry: 8
  });

// ===================== LEGEND (Slim Pills, no title/actions) =====================
function groupTotalsFrom(original){
  const totals = {};
  normalizeData(original).forEach(d => {
    totals[d.parent] = (totals[d.parent]||0) + (+d.value||0);
  });
  return totals;
}
function formatPct(x){ return (Math.round(x*10)/10).toFixed(1) + "%"; }

function buildLegend(){ 
  const totals = groupTotalsFrom(originalData);
  const sumAll = Object.values(totals).reduce((a,b)=>a+b,0) || 1;

  const el = document.getElementById('legend');
  el.innerHTML = "";

  const pills = document.createElement('div');
  pills.className = 'legend-pills';

  const ordered = [...groups].sort((a,b)=> (totals[b]||0)-(totals[a]||0));

  ordered.forEach(g=>{
    const pill = document.createElement('button');
    pill.className = 'legend-pill' + (activeGroups.has(g) ? '' : ' inactive');
    pill.setAttribute('data-group', g);
    pill.setAttribute('aria-pressed', activeGroups.has(g) ? 'true' : 'false');
    pill.title = g;

    const dot = document.createElement('span');
    dot.className = 'legend-dot';
    dot.style.background = getGroupColor(g);

    const label = document.createElement('span');
    label.className = 'legend-label';
    label.textContent = g;

    const val = document.createElement('span');
    val.className = 'legend-val';
    val.textContent = formatPct((totals[g]||0) / sumAll * 100);

    pill.appendChild(dot);
    pill.appendChild(label);
    pill.appendChild(val);

    pill.addEventListener('click', ()=>{
      if (activeGroups.has(g)) activeGroups.delete(g); else activeGroups.add(g);
      updateVisualization();
    });

    pills.appendChild(pill);
  });

  el.appendChild(pills);
}

// keep legend pills in sync after each render/filter
const _origUpdate = function(){
  var normalized = normalizeData(originalData);
  var filteredData = normalized.filter(function(d){ return activeGroups.has(d.parent); });
  data = filteredData;
  treemap.data(data).render();

  document.querySelectorAll('.legend-item').forEach(function(item){
    var grp = item.getAttribute('data-group');
    var isActive = activeGroups.has(grp);
    item.classList.toggle('inactive', !isActive);
    item.classList.toggle('active', isActive);
    item.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
};
function updateVisualization(){
  _origUpdate();
  document.querySelectorAll('.legend-pill').forEach(p=>{
    const grp = p.getAttribute('data-group');
    const on = activeGroups.has(grp);
    p.classList.toggle('inactive', !on);
    p.setAttribute('aria-pressed', on ? 'true' : 'false');
  });
}

treemap.render();
buildLegend();
updateVisualization();

// ===================== Overlap handling (logo/source vs legend) =====================
function debouncedCheckOverlap(){ checkOverlap(); }
function checkOverlap(){
  var legend = document.querySelector('.custom-legend');
  var logo = document.querySelector('.logo');
  var sourceText = document.querySelector('.source-text');
  if(!legend || !logo || !sourceText) return;
  var legendRect = legend.getBoundingClientRect();
  var logoRect = logo.getBoundingClientRect();
  var sourceRect = sourceText.getBoundingClientRect();
  var logoOverlap = !(legendRect.right < logoRect.left || legendRect.left > logoRect.right || legendRect.bottom < logoRect.top || legendRect.top > logoRect.bottom);
  var sourceOverlap = !(legendRect.right < sourceRect.left || legendRect.left > sourceRect.right || legendRect.bottom < sourceRect.top || legendRect.top > sourceRect.bottom);
  logo.classList.toggle('overlapped', logoOverlap);
  sourceText.classList.toggle('overlapped', sourceOverlap);
}
var observer = new MutationObserver(function(){ debouncedCheckOverlap(); });
observer.observe(document.body,{childList:true,subtree:true});
window.addEventListener('resize', debouncedCheckOverlap);
setTimeout(debouncedCheckOverlap,200);
</script>

<a href="https://aiworld.eu/" target="_blank" rel="noopener">
  <img src="https://aiworld.eu/logo-transparent.svg" class="logo" alt="AI World logo"/>
</a>
<div class="source-text">Source: <a href="https://www.crunchbase.com" target="_blank" rel="noopener">Crunchbase</a></div>

</body>
</html>
