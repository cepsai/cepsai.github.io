<!doctype html>
<html>
<head>
<meta charset="utf-8">
<style type="text/css">
.knitr .inline { background-color: #F7F7F7; border: solid 1px #B0B0B0; }
.error { font-weight: bold; color: #FF0000; }
.warning { font-weight: bold; }
.message { font-style: italic; }
.source, .output, .warning, .error, .message { padding: 0 1em; border: solid 1px #F7F7F7; }
.source { background-color: #F5F5F5; }
.rimage .left { text-align: left; }
.rimage .right { text-align: right; }
.rimage .center { text-align: center; }
.hl.num { color: #AF0F91; }
.hl.str { color: #317ECC; }
.hl.com { color: #AD95AF; font-style: italic; }
.hl.opt { color: #000000; }
.hl.std { color: #585858; }
.hl.kwa { color: #295F94; font-weight: bold; }
.hl.kwb { color: #B05A65; }
.hl.kwc { color: #55AA55; }
.hl.kwd { color: #BC5A65; font-weight: bold; }
body { margin: 0; overflow: hidden; height: 100vh; font-family: Arial, sans-serif; }

.viz-grid { display: grid; grid-template-rows: 17fr 2fr 1fr; grid-template-columns: 1fr 1fr; height: 100vh; width: 100vw; box-sizing: border-box; padding-bottom: clamp(8px, 2vh, 18px); }
#container1 { grid-row: 1; grid-column: 1 / span 2; overflow: hidden; min-height: 0; }
#container2 { grid-row: 2; grid-column: 1 / span 2; display: flex; align-items: center; justify-content: center; overflow: hidden; }
#container3 { grid-row: 3; grid-column: 1; display: flex; align-items: center; justify-content: flex-start; padding: 0 20px; overflow: hidden; min-width: 0; }
#container4 { grid-row: 3; grid-column: 2; display: flex; align-items: center; justify-content: flex-end; padding: 0 20px; overflow: hidden; min-width: 0; }
#container4 a { height: 100%; display: flex; align-items: center; }

#treemap { width: 100%; height: 100%; min-height: 0; min-width: 0; }
.logo { height: 100%; width: auto; max-height: 100%; max-width: 100%; pointer-events: auto; object-fit: contain; }
.source-text { font-size: clamp(10px, 1.6vw, 16px); font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; font-style: normal; }
.source-text a { color: #2756d3; text-decoration: underline; cursor: pointer; font-style: normal; }
.source-text a:visited { color: #2756d3; }
.node-label { display: flex; align-items: center; justify-content: flex-start; gap: clamp(4px, 1vw, 12px); pointer-events: none; font-weight: 600; font-size: clamp(10px, 1.4vw, 18px); line-height: 1.2; text-align: left; white-space: nowrap; width: 100%; height: 100%; box-sizing: border-box; padding: clamp(4px, 0.8vw, 8px); overflow: hidden; text-overflow: ellipsis; }
.node-label .node-logo { flex: 0 0 auto; width: clamp(18px, 3vw, 36px); height: clamp(18px, 3vw, 36px); object-fit: contain; border-radius: 4px; background: rgba(255, 255, 255, 0.25); box-shadow: 0 1px 2px rgba(0,0,0,0.25); }
.node-label .node-name { flex: 1 1 auto; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.custom-legend { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: clamp(6px, 1.5vw, 14px); background: rgba(255, 255, 255, 0.9); padding: clamp(6px, 1.2vh, 10px) clamp(10px, 2vw, 16px); border-radius: clamp(6px, 1.2vw, 12px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: auto; max-width: 100%; max-height: 100%; font-size: clamp(10px, 1.6vw, 16px); font-weight: 600; }
.legend-item { display: flex; align-items: center; gap: 8px; cursor: pointer; transition: opacity 0.2s ease; font-weight: 600; color: #333; position: relative; }
.legend-item.inactive { opacity: 0.35; }
.legend-logo { width: clamp(20px, 2.4vw, 28px); height: clamp(20px, 2.4vw, 28px); object-fit: contain; border-radius: 4px; box-shadow: 0 0 0 1px rgba(0,0,0,0.1); background: #fff; padding: 2px; }
.legend-item:focus-visible { outline: 2px solid rgba(0,0,0,0.5); outline-offset: 2px; }

@media (max-height: 500px) {
  .viz-grid { grid-template-rows: 1fr; grid-template-columns: 1fr; }
  #container1 { grid-row: 1; grid-column: 1; }
  #container2, #container3, #container4 { display: none !important; }
  .custom-legend, .source-text, .logo { display: none !important; }
}
</style>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3plus-hierarchy@1"></script>
</head>
<body>
<div class="viz-grid">
  <div id="container1" class="container treemap-container">
    <div id="treemap"></div>
  </div>
  <div id="container2" class="container legend-container">
    <div class="custom-legend" id="legend"></div>
  </div>
  <div id="container3" class="container source-container">
    <div class="source-text">Source: <a href="https://harmonic.ai/" target="_blank">Harmonic, </a><a href="https://www.linkedin.com/posts/rubendominguezibar_just-in-where-openais-talent-actually-activity-7387551203829895168-1Rjz/?utm_source=social_share_send&utm_medium=member_desktop_web&rcm=ACoAAALH5GsBL1h0walRpP3INmuQxWM0v1bUoUU" target="_blank">Rub√©n Dominguez</a></div>
  </div>
  <div id="container4" class="container logo-container">
    <a href="https://aiworld.eu/" target="_blank" rel="noopener">
      <img src="https://aiworld.eu/logo-transparent.svg" class="logo" alt="AI World logo"/>
    </a>
  </div>
</div>
<script>
var originalData = [
  {
    "name": "Stanford University",
    "parent": "Stanford",
    "location": "Stanford, CA",
    "value": 422,
    "color": "#8C1515",
    "logo": "logos/stanford.png"
  },
  {
    "name": "UC Berkeley",
    "parent": "UC",
    "location": "Berkeley, CA",
    "value": 316,
    "color": "#003262",
    "logo": "logos/berkeley.png"
  },
  {
    "name": "MIT",
    "parent": "MIT",
    "location": "Cambridge, MA",
    "value": 230,
    "color": "#A31F34",
    "logo": "logos/mit.png"
  },
  {
    "name": "Carnegie Mellon",
    "parent": "Carnegie Mellon",
    "location": "Pittsburgh, PA",
    "value": 198,
    "color": "#C70E1F",
    "logo": "logos/carnegie.png"
  },
  {
    "name": "Harvard",
    "parent": "Harvard",
    "location": "Cambridge, MA",
    "value": 144,
    "color": "#A41034",
    "logo": "logos/harvard.png"
  },
  {
    "name": "UCLA",
    "parent": "UC",
    "location": "Los Angeles, CA",
    "value": 106,
    "color": "#2774AE",
    "logo": "logos/ucla.png"
  },
  {
    "name": "USC",
    "parent": "USC",
    "location": "Los Angeles, CA",
    "value": 83,
    "color": "#990000",
    "logo": "logos/usc.png"
  },
  {
    "name": "Columbia",
    "parent": "Columbia",
    "location": "New York, NY",
    "value": 82,
    "color": "#69B3E7",
    "logo": "logos/columbia.png"
  },
  {

    "name": "NYU",
    "parent": "New York University",
    "location": "New York, NY",
    "value": 81,
    "color": "#57068C",
    "logo": "logos/nyu.png"
  },
  {
    "name": "Cornell University",
    "parent": "Cornell University",
    "location": "Ithaca, NY",
    "value": 79,
    "color": "#B31B1B",
    "logo": "logos/cornell.png"
  }
];
function normalizeData(arr){
  return arr.map(function(d){
    var parent = d.parent || d.group || d.domain || d.category || d.type || d.class;
    var name = d.name || d.id || d.label || d.title;
    var value = (d.value != null) ? +d.value : (d.count != null) ? +d.count : (d.size != null) ? +d.size : 0;
    var logo = d.logo || d.image || d.logoUrl || d.icon || null;
    var color = d.color || null;
    var location = d.location || d.city || d.country || null;
    return { parent: parent, name: name, value: value, logo: logo, color: color, location: location };
  });
}
var data = normalizeData(originalData);
var groups = Array.from(new Set(data.map(function(d){ return d.parent; })));
var inferredColors = {};
groups.forEach(function(g){
  var item = originalData.find(function(x){ var p = x.parent || x.group || x.domain || x.category || x.type || x.class; return p === g; });
  inferredColors[g] = item && item.color ? item.color : null;
});
var fallbackPalette = ["#1F77B4","#FF7F0E","#2CA02C","#9467BD","#D62728","#17BECF","#8C564B","#E377C2","#7F7F7F","#BCBD22"];
var groupColors = {};
groups.forEach(function(g, i){ groupColors[g] = inferredColors[g] || fallbackPalette[i % fallbackPalette.length]; });
var activeGroups = new Set(groups);
function getGroupColor(parent){ return groupColors[parent] || "#666666"; }
function getGroupLogo(parent){
  if(!parent) return null;
  var match = originalData.find(function(x){
    var p = x.parent || x.group || x.domain || x.category || x.type || x.class;
    return p === parent;
  });
  if(!match) return null;
  return match.logo || match.image || match.logoUrl || match.icon || null;
}
function getReadableTextColor(hex){
  if(!hex || typeof hex !== "string") return "#111111";
  var cleaned = hex.replace("#", "");
  if(cleaned.length === 3){
    cleaned = cleaned.split("").map(function(ch){ return ch + ch; }).join("");
  }
  if(cleaned.length !== 6) return "#111111";
  var r = parseInt(cleaned.substr(0,2), 16);
  var g = parseInt(cleaned.substr(2,2), 16);
  var b = parseInt(cleaned.substr(4,2), 16);
  if([r,g,b].some(function(v){ return isNaN(v); })) return "#111111";
  var luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.6 ? "#111111" : "#FFFFFF";
}
function buildLegend(){
  var legend = document.getElementById('legend');
  if(!legend) return;
  legend.innerHTML = '';
  groups.forEach(function(g){
    var item = document.createElement('div');
    item.className = 'legend-item active';
    item.setAttribute('data-group', g);
    item.setAttribute('role','button');
    item.setAttribute('tabindex','0');
    item.setAttribute('aria-pressed','true');
    var logoUrl = getGroupLogo(g);
    var square;
    if(logoUrl){
      square = document.createElement('img');
      square.className = 'legend-logo';
      square.src = logoUrl;
      square.alt = g + ' logo';
      square.onerror = function(){ this.style.display = 'none'; };
    } else {
      square = document.createElement('div');
      square.className = 'legend-logo';
      square.style.backgroundColor = getGroupColor(g);
    }
    var label = document.createElement('span');
    label.textContent = g;
    item.appendChild(square);
    item.appendChild(label);
    item.addEventListener('click', function(){
      var grp = this.getAttribute('data-group');
      if(activeGroups.has(grp)){ activeGroups.delete(grp); } else { activeGroups.add(grp); }
      updateVisualization();
    });
    item.addEventListener('keydown', function(e){
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        var grp = this.getAttribute('data-group');
        if(activeGroups.has(grp)){ activeGroups.delete(grp); } else { activeGroups.add(grp); }
        updateVisualization();
      }
    });
    legend.appendChild(item);
  });
}
var treemap = new d3plus.Treemap()
  .select("#treemap")
  .data(data)
  .groupBy(["parent","name"])
  .tooltipConfig({
    title:function(d){ return d.name; },
    body:function(d){
      var location = d.location || (d.data && (d.data.location || d.data.city || d.data.country)) || d.id || "";
      var base = "<strong>University:</strong> " + (d.parent || d.id) + "<br><strong>Count:</strong> " + (d.value || 0) + "<br><strong>Location:</strong> " + location;
      return base;
    }
  })
  .sum("value")
  .layoutPadding(2)
  .legend(false)
  .color(function(d){ return getGroupColor(d.parent || d.id); })
  .shapeConfig({
    rx: 6,
    ry: 6,
    stroke:function(d){ if(d.depth===0){ return getGroupColor(d.id); } return "transparent"; },
    strokeWidth:function(d){ if(d.depth===0){ return 3; } return 0; }
  });
treemap.on("rendered", function(){
  if(typeof requestAnimationFrame === "function"){
    requestAnimationFrame(applyLogosToLabels);
  } else {
    setTimeout(applyLogosToLabels, 0);
  }
});
function extractNodeDatum(bound){
  if(!bound) return null;
  if(bound.data && bound.data.data) return bound.data.data;
  if(bound.data) return bound.data;
  return bound;
}
function isLeafHierarchyNode(bound){
  return !(bound && Array.isArray(bound.children) && bound.children.length);
}
function deriveNodeLabel(datum, bound){
  if(datum){
    var name = datum.name || datum.label || datum.title || datum.id;
    if(name) return name;
  }
  if(bound){
    return bound.id || bound.key || bound.name || "";
  }
  return "";
}
function deriveParentLabel(datum, bound){
  if(datum && datum.parent) return datum.parent;
  if(bound && bound.parent){
    var parentData = bound.parent.data;
    if(parentData){
      var normalizedParent = parentData.data || parentData;
      var alias = normalizedParent && (normalizedParent.name || normalizedParent.label || normalizedParent.title || normalizedParent.id);
      if(alias) return alias;
    }
    return bound.parent.id || bound.parent.key || "";
  }
  return "";
}
function renderLabelWithLogo(box, name, logoUrl, textColor){
  if(!logoUrl) return;
  box.dataset.logoApplied = "true";
  box.classList.add("node-label");
  box.style.display = "flex";
  box.style.alignItems = "center";
  box.style.justifyContent = "flex-start";
  box.style.gap = "clamp(4px, 1vw, 12px)";
  box.style.pointerEvents = "none";
  box.style.color = textColor;
  box.style.fontWeight = "600";
  box.style.textShadow = (textColor === "#FFFFFF") ? "0 1px 2px rgba(0,0,0,0.45)" : "none";
  box.innerHTML = "";
  var img = document.createElement("img");
  img.className = "node-logo";
  img.src = logoUrl;
  img.alt = name + " logo";
  img.loading = "lazy";
  img.onerror = function(){ this.style.display = "none"; };
  box.appendChild(img);
  var span = document.createElement("span");
  span.className = "node-name";
  span.textContent = name;
  box.appendChild(span);
  box.title = name;
}
function restoreLabel(box, text){
  box.classList.remove("node-label");
  box.style.removeProperty("display");
  box.style.removeProperty("align-items");
  box.style.removeProperty("justify-content");
  box.style.removeProperty("gap");
  box.style.removeProperty("pointer-events");
  box.style.removeProperty("color");
  box.style.removeProperty("font-weight");
  box.style.removeProperty("text-shadow");
  box.innerHTML = "";
  if(text != null){
    box.textContent = text;
    box.title = text;
  }
  delete box.dataset.logoApplied;
}
function applyLogosToLabels(){
  var host = document.getElementById("treemap");
  if(!host) return;
  var textBoxes = host.querySelectorAll(".d3plus-textBox");
  textBoxes.forEach(function(box){
    var bound = box.__data__ || (box.parentNode && box.parentNode.__data__) || null;
    if(!bound) return;
    var datum = extractNodeDatum(bound);
    if(!datum) return;
    var labelText = deriveNodeLabel(datum, bound) || "";
    var isLeaf = isLeafHierarchyNode(bound);
    var logoUrl = datum.logo || datum.image || datum.logoUrl || datum.icon || null;
    if(isLeaf && logoUrl){
      var width = box.offsetWidth;
      var height = box.offsetHeight;
      if(width <= 0 || height <= 0){
        return;
      }
      var parentKey = deriveParentLabel(datum, bound);
      var fillColor = getGroupColor(parentKey);
      var readableColor = getReadableTextColor(fillColor);
      renderLabelWithLogo(box, labelText, logoUrl, readableColor);
    } else if (box.dataset.logoApplied === "true"){
      restoreLabel(box, labelText);
    }
  });
}
function updateVisualization(){
  var normalized = normalizeData(originalData);
  var filteredData = normalized.filter(function(d){ return activeGroups.has(d.parent); });
  data = filteredData;
  treemap.data(data).render();
  if(typeof requestAnimationFrame === "function"){
    requestAnimationFrame(applyLogosToLabels);
  } else {
    setTimeout(applyLogosToLabels, 0);
  }
  document.querySelectorAll('.legend-item').forEach(function(item){
    var grp = item.getAttribute('data-group');
    var isActive = activeGroups.has(grp);
    item.classList.toggle('inactive', !isActive);
    item.classList.toggle('active', isActive);
    item.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
}
treemap.render();
buildLegend();
updateVisualization();
function renderToContainerSize(){
  var el = document.getElementById('treemap');
  if(!el) return;
  var rect = el.getBoundingClientRect();
  try {
    if(typeof treemap.width === 'function') treemap.width(rect.width);
    if(typeof treemap.height === 'function') treemap.height(rect.height);
  } catch(e) {}
  treemap.render();
  if(typeof requestAnimationFrame === "function"){
    requestAnimationFrame(applyLogosToLabels);
  } else {
    setTimeout(applyLogosToLabels, 0);
  }
}
var _resizeTimer;
window.addEventListener('resize', function(){
  clearTimeout(_resizeTimer);
  _resizeTimer = setTimeout(renderToContainerSize, 120);
});
if (typeof ResizeObserver !== 'undefined') {
  var _ro = new ResizeObserver(function(){ renderToContainerSize(); });
  _ro.observe(document.getElementById('treemap'));
}
</script>
</body>
</html>
