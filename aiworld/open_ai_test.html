<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Treemap with One-Line Legend + Fullscreen + Safe Zones</title>
<style>
:root{
  --legendHeight: clamp(70px, 10vh, 110px);
  --legendHeightCompact: 46px;
}
html, body { margin:0; height:100%; }
body { overflow:hidden; background:#fff; }

/* Chart area respects footer height */
#treemap { position:absolute; inset:0 0 var(--legendHeight) 0; }

/* Footer with legend (one-line fit) */
.controls-section{
  position:absolute; left:0; right:0; bottom:0;
  height:var(--legendHeight);
  display:flex; align-items:center; justify-content:center;
  pointer-events:none; padding:0 12px; transition:height .18s ease;
}
.controls-inner{
  position:relative; width:100%; max-width:1700px;
  display:flex; align-items:center; justify-content:center;
  pointer-events:none;
}
.custom-legend{
  pointer-events:auto; display:inline-flex; align-items:center;
  gap:6px 8px; padding:8px 10px; border-radius:16px;
  backdrop-filter:blur(6px); background:rgba(255,255,255,.9);
  border:1px solid rgba(0,0,0,.06); box-shadow:0 6px 22px rgba(0,0,0,.08);

  /* one-line auto-fit */
  max-width:100%; white-space:nowrap; flex-wrap:nowrap;
  transform:scale(var(--legendScale,1)); transform-origin:left center;
  will-change:transform;
  font:500 clamp(10px,1vw,13px)/1.1 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
  color:#3a3a3a;
  z-index: 900; /* keep under source/logo just in case */
}
.legend-pills{ display:inline-flex; flex-wrap:nowrap; gap:6px 8px; }
.legend-pill{
  display:inline-flex; align-items:center; gap:6px;
  padding:4px 7px; border-radius:999px; cursor:pointer;
  background:#fff; border:1px solid rgba(0,0,0,.07);
  transition:transform .08s ease, opacity .2s ease, background .2s ease;
}
.legend-pill:hover{ transform:translateY(-1px); }
.legend-pill.inactive{ opacity:.35; }
.legend-dot{ width:10px; height:10px; border-radius:50%; box-shadow:0 0 0 1px rgba(0,0,0,.15) inset; }
.legend-label{ font-weight:560; }
.legend-val{ margin-left:2px; opacity:.7; font-variant-numeric:tabular-nums; }
.custom-legend.compact .legend-val{ display:none; }

/* Fullscreen button (top-right) */
.fs-btn{
  position:fixed; top:14px; right:14px; z-index:2000;
  width:48px; height:48px; border-radius:50%;
  background:rgba(0,0,0,.72); border:none; cursor:pointer;
  display:grid; place-items:center;
  box-shadow:0 8px 28px rgba(0,0,0,.25);
}
.fs-btn:hover{ background:rgba(0,0,0,.82); }
.fs-btn:active{ transform:scale(.98); }
.fs-btn svg{ width:24px; height:24px; stroke:#fff; stroke-width:2.5; fill:none; }

/* When fullscreen: shrink footer for extra chart space */
body.is-fullscreen #treemap{ inset:0 0 var(--legendHeightCompact) 0; }
body.is-fullscreen .controls-section{ height:var(--legendHeightCompact); }

/* Brand / source */
.logo{ position:absolute; bottom:clamp(6px,4vh,20px); right:20px; width:clamp(70px,8.5vw,140px); z-index:1100; transition:opacity .3s; }
.source-text{ position:absolute; bottom:clamp(10px,4vh,30px); left:20px; font-size:clamp(11px,1.2vw,16px); font-weight:700; color:#555; font-style:italic; z-index:1100; }
.source-text a{ color:#5a2ea6; text-decoration:none; border-bottom:1px solid rgba(90,46,166,.35); }
.source-text a:hover{ opacity:.8; }

/* Low-profile scrollbar if needed */
.custom-legend::-webkit-scrollbar{ height:6px; }
.custom-legend::-webkit-scrollbar-thumb{ background:rgba(0,0,0,.12); border-radius:6px; }
</style>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3plus-hierarchy@1"></script>
</head>
<body>

<!-- Fullscreen toggle -->
<button id="fsBtn" class="fs-btn" aria-label="Enter fullscreen">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M9 3H4v5M15 3h5v5M9 21H4v-5M15 21h5v-5" />
  </svg>
</button>

<div id="treemap"></div>

<div class="controls-section">
  <div class="controls-inner">
    <div class="custom-legend" id="legend"></div>
  </div>
</div>

<script>
// ---------- Data ----------
var originalData = [
  { "id": "Generate Or Retrieve Other Media", "parent": "Multimedia", "color": "#98c8e3", "value": 1.1 },
  { "id": "Create An Image", "parent": "Multimedia", "color": "#b7d6ea", "value": 4.2 },
  { "id": "Analyze An Image", "parent": "Multimedia", "color": "#c2ddec", "value": 0.6 },
  { "id": "Other / Unknown", "parent": "Other / Unknown", "color": "#fdae6b", "value": 4.1 },
  { "id": "Asking About The Model", "parent": "Other / Unknown", "color": "#fd8d3c", "value": 0.4 },
  { "id": "Tutoring Or Teaching", "parent": "Practical Guidance", "color": "#52c167", "value": 10.2 },
  { "id": "How To Advice", "parent": "Practical Guidance", "color": "#88d291", "value": 8.5 },
  { "id": "Health, Fitness, Beauty Or Self Care", "parent": "Practical Guidance", "color": "#8cd698", "value": 5.7 },
  { "id": "Creative Ideation", "parent": "Practical Guidance", "color": "#b2e0b9", "value": 3.9 },
  { "id": "Specific Info", "parent": "Seeking Information", "color": "#f56f75", "value": 18.3 },
  { "id": "Purchasable Products", "parent": "Seeking Information", "color": "#f68d90", "value": 2.1 },
  { "id": "Cooking And Recipes", "parent": "Seeking Information", "color": "#b98e90", "value": 0.9 },
  { "id": "Relationships And Personal Reflection", "parent": "Self-Expression", "color": "#f0e7f4", "value": 1.9 },
  { "id": "Greetings And Chitchat", "parent": "Self-Expression", "color": "#f4eef7", "value": 2.0 },
  { "id": "Games And Role Play", "parent": "Self-Expression", "color": "#b6b2b8", "value": 0.4 },
  { "id": "Mathematical Calculation", "parent": "Technical Help", "color": "#967c79", "value": 3.0 },
  { "id": "Data Analysis", "parent": "Technical Help", "color": "#e6d4d1", "value": 0.4 },
  { "id": "Computer Programming", "parent": "Technical Help", "color": "#e6d4d1", "value": 4.2 },
  { "id": "Write Fiction", "parent": "Writing", "color": "#da8ec0", "value": 1.4 },
  { "id": "Translation", "parent": "Writing", "color": "#fbb0e0", "value": 4.5 },
  { "id": "Personal Writing Or Communication", "parent": "Writing", "value": 8.0, "color":"#fbcce9" },
  { "id": "Edit Or Critique Provided Text", "parent": "Writing", "color": "#fbcce9", "value": 10.6 },
  { "id": "Argument Or Summary Generation", "parent": "Writing", "color": "#fde1f2", "value": 3.6 }
];

// ---------- Utils ----------
function normalizeData(arr){
  return arr.map(function(d){
    var parent = d.parent || d.group || d.domain || d.category || d.type || d.class;
    var name = d.name || d.id || d.label || d.title;
    var value = (d.value != null) ? +d.value : (d.count != null) ? +d.count : (d.size != null) ? +d.size : 0;
    return { parent: parent, name: name, value: value };
  });
}
var data = normalizeData(originalData);
var groups = Array.from(new Set(data.map(d => d.parent)));
var inferredColors = {};
groups.forEach(function(g){
  var item = originalData.find(function(x){
    var p = x.parent || x.group || x.domain || x.category || x.type || x.class;
    return p === g;
  });
  inferredColors[g] = item && item.color ? item.color : null;
});
var fallbackPalette = ["#1F77B4","#FF7F0E","#2CA02C","#9467BD","#D62728","#17BECF","#8C564B","#E377C2","#7F7F7F","#BCBD22"];
var groupColors = {};
groups.forEach(function(g, i){ groupColors[g] = inferredColors[g] || fallbackPalette[i % fallbackPalette.length]; });
var activeGroups = new Set(groups);
function getGroupColor(parent){ return groupColors[parent] || "#666"; }

// ---------- Treemap ----------
var treemap = new d3plus.Treemap()
  .select("#treemap")
  .data(data)
  .groupBy(["parent","name"])
  .tooltipConfig({
    title:function(d){ return d.name; },
    body:function(d){ return "<strong>Class:</strong> " + (d.parent||d.id) + "<br><strong>Count:</strong> " + (d.value||0); }
  })
  .sum("value")
  .layoutPadding(2)
  .legend(false)
  .color(function(d){ return getGroupColor(d.parent || d.id); })
  .shapeConfig({
    stroke:function(d){ if(d.depth===0){ return getGroupColor(d.id); } return "transparent"; },
    strokeWidth:function(d){ if(d.depth===0){ return 3; } return 0; },
    rx:8, ry:8
  });

// ---------- Legend (slim pills) ----------
function groupTotalsFrom(original){
  const totals = {};
  normalizeData(original).forEach(d => {
    totals[d.parent] = (totals[d.parent]||0) + (+d.value||0);
  });
  return totals;
}
function formatPct(x){ return (Math.round(x*10)/10).toFixed(1) + "%"; }

function buildLegend(){ 
  const totals = groupTotalsFrom(originalData);
  const sumAll = Object.values(totals).reduce((a,b)=>a+b,0) || 1;
  const el = document.getElementById('legend');
  el.innerHTML = "";
  const pills = document.createElement('div'); pills.className = 'legend-pills';

  const ordered = [...groups].sort((a,b)=> (totals[b]||0)-(totals[a]||0));
  ordered.forEach(g=>{
    const pill = document.createElement('button');
    pill.className = 'legend-pill' + (activeGroups.has(g)?'':' inactive');
    pill.setAttribute('data-group', g);
    pill.setAttribute('aria-pressed', activeGroups.has(g) ? 'true' : 'false');
    pill.title = g;

    const dot = document.createElement('span'); dot.className='legend-dot'; dot.style.background = getGroupColor(g);
    const label = document.createElement('span'); label.className='legend-label'; label.textContent = g;
    const val = document.createElement('span'); val.className='legend-val'; val.textContent = " " + formatPct((totals[g]||0)/sumAll*100);

    pill.appendChild(dot); pill.appendChild(label); pill.appendChild(val);
    pill.addEventListener('click', ()=>{ activeGroups.has(g) ? activeGroups.delete(g) : activeGroups.add(g); updateVisualization(); });
    pills.appendChild(pill);
  });

  el.appendChild(pills);
}

// keep legend classes synced after render/filter
const _origUpdate = function(){
  var normalized = normalizeData(originalData);
  var filteredData = normalized.filter(d => activeGroups.has(d.parent));
  data = filteredData;
  treemap.data(data).render();
};
function updateVisualization(){
  _origUpdate();
  document.querySelectorAll('.legend-pill').forEach(p=>{
    const grp = p.getAttribute('data-group');
    const on = activeGroups.has(grp);
    p.classList.toggle('inactive', !on);
    p.setAttribute('aria-pressed', on ? 'true' : 'false');
  });
  fitLegendToOneLine();
}

// ---------- One-line auto-fit WITH SAFE ZONES ----------
function fitLegendToOneLine() {
  const container = document.querySelector('.controls-section');
  const legend = document.getElementById('legend');
  const source = document.querySelector('.source-text');
  const logo = document.querySelector('.logo');
  if (!container || !legend) return;

  // reset
  legend.style.setProperty('--legendScale', 1);
  legend.classList.remove('compact');

  // reserve room for source (left) and logo (right)
  const GAP = 18;
  const leftReserve = source ? (source.getBoundingClientRect().width + GAP) : 0;
  const rightReserve = logo ? (logo.getBoundingClientRect().width + GAP) : 0;

  const available = container.clientWidth - leftReserve - rightReserve - 24; // 24 = side padding
  const needed = legend.scrollWidth;

  let scale = Math.min(1, available / Math.max(1, needed));
  legend.style.setProperty('--legendScale', scale);

  // If still tight, hide the % values then re-measure
  if (scale < 0.92) {
    legend.classList.add('compact');
    legend.style.setProperty('--legendScale', 1);
    const neededNoPct = legend.scrollWidth;
    scale = Math.min(1, available / Math.max(1, neededNoPct));
    legend.style.setProperty('--legendScale', scale);
  }
}

// ---------- Fullscreen toggle ----------
const fsBtn = document.getElementById('fsBtn');
function enterFS(el){
  if (el.requestFullscreen) return el.requestFullscreen();
  if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
  if (el.msRequestFullscreen) return el.msRequestFullscreen();
}
function exitFS(){
  if (document.exitFullscreen) return document.exitFullscreen();
  if (document.webkitExitFullscreen) return document.webkitExitFullscreen();
  if (document.msExitFullscreen) return document.msExitFullscreen();
}
function isFS(){
  return document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement;
}
fsBtn.addEventListener('click', ()=>{
  if (!isFS()) enterFS(document.documentElement);
  else exitFS();
});
['fullscreenchange','webkitfullscreenchange','MSFullscreenChange'].forEach(evt=>{
  document.addEventListener(evt, ()=>{
    const on = !!isFS();
    document.body.classList.toggle('is-fullscreen', on);
    fsBtn.setAttribute('aria-label', on ? 'Exit fullscreen' : 'Enter fullscreen');
    treemap.render();
    fitLegendToOneLine();
  });
});

// ---------- Boot ----------
treemap.render();
buildLegend();
updateVisualization();
window.addEventListener('resize', fitLegendToOneLine);
</script>

<!-- Brand / source (left & right) -->
<a href="https://aiworld.eu/" target="_blank" rel="noopener">
  <img src="https://aiworld.eu/logo-transparent.svg" class="logo" alt="AI World logo"/>
</a>
<div class="source-text">Source: <a href="https://www.crunchbase.com" target="_blank" rel="noopener">Crunchbase</a></div>

</body>
</html>
