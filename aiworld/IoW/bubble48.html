<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --fg:#111; --bg:#fff; --muted:#6b7280; --axis:#000; --accent:#0ea5a4; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}

  /* Contenedor a pantalla completa en columna */
  .wrap{
    min-height:100vh;         /* ocupa el alto de la ventana (mejor en móvil) */
    display:flex;
    flex-direction:column;
    gap:8px;
    padding:0;
    max-width:none;            /* sin límite de ancho */
    margin:0;
  }

  h1{font-size:1.3rem;margin:0}
  .sub{color:var(--muted);margin:0 0 8px}

  /* El SVG crece para llenar el espacio restante */
  #chart{
    width:100%;
    height:100svh;             
    display:block;
  }
    
  .cluster-title{
    font-weight:700;
    font-size: 12px;
    fill:#000;
  }
  .cluster-total{
    font-weight:600;
    font-size: 14px;
    fill:#000;
  }
  .axis text{fill:#000;font-size:.85rem; font-weight: 600;}
  .axis path,.axis line{stroke:var(--axis)}
  .grid line{stroke:var(--axis)}
  .label{fill:#000;font-size:.85rem; font-weight: 600}
  .dot{cursor:pointer;transition:filter .15s ease}
  .dot:hover{filter:drop-shadow(0 2px 6px rgba(0,0,0,.2))}
  .logo-circle{cursor:pointer;transition:filter .15s ease}
  .logo-circle:hover{filter:drop-shadow(0 2px 6px rgba(0,0,0,.2))}
  .tooltip{
    position:fixed; pointer-events:none; opacity:0; transition:opacity .12s ease;
    background:#111;color:#fff;border-radius:10px;padding:8px 10px;font-size:.85rem
  }

  /* La leyenda queda abajo; el SVG crece por encima */
  .legend{display:flex;gap:15px;align-items:center;margin-top:15px;color:#374151}
  .badge{width:10px;height:7px;border-radius:999px;background:var(--accent)}
  /* ===== Legend style copied from mistral-ai-investment ===== */
  .custom-legend{
    position:absolute;
    top:calc(100vh - clamp(64px, 10vh, 100px) + 6px);
    left:50%;
    transform:translateX(-50%);
    display:flex;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
    gap: clamp(6px, 1.2vw, px);
    column-gap: clamp(10px, 2vw, 16px);
    row-gap: clamp(4px, 1vh, 8px);
    background:rgba(255,255,255,0.92);
    padding: clamp(6px, 1.2vh, 10px) clamp(10px, 2vw, 16px);
    border-radius: clamp(3px, .8vw, 6px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    font-family: Arial, sans-serif;
    font-size: clamp(10px, 1.1vw, 14px);
    font-weight: 500;
    z-index: 1000;
    opacity: 1;
    transition: opacity .3s ease
  }
  .custom-legend.overlapped{opacity:.15}
  .custom-legend.overlapped:hover{opacity:1}
  .legend-item{display:flex;align-items:center;gap:6px;cursor:pointer;transition:opacity .3s ease;position:relative}
  .legend-item.inactive{opacity:.35}
  .legend-item:hover{opacity:1}
  .legend-square{width:clamp(8px,1vw,12px);height:clamp(8px,1vw,12px);border-radius:clamp(2px,.5vw,3px);position:relative;box-shadow:0 0 0 1px rgba(0,0,0,.15) inset}
  .legend-item:focus-visible{outline:2px solid rgba(0,0,0,.6);outline-offset:2px}

  .footer-bar { position: fixed; bottom: 12px; left: 0; right: 0; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 12px; padding: 6px 12px; background: rgba(255,255,255,0.95); box-shadow: 0 -2px 6px rgba(255, 255, 255, 0.06); z-index: 1000; }
  .source-text { justify-self: start; font-size: 16px; font-weight: 600; color: #000000; }
  .brand-link { justify-self: end; }
  .brand-logo { width: 110px; height: auto; }
  .custom-legend { position: static; transform: none; top: auto; left: auto; }
</style>
</head>
<body>
<div class="wrap">
  <!-- El viewBox permite que todo escale perfecto sin JS extra -->
  <svg id="chart" viewBox="0 0 900 520" role="img" aria-label="Bubble chart con logos"></svg>
  <div class="footer-bar">
  <div class="source-text">Source: <a href="https://www.crunchbase.com" target="_blank" rel="noopener">Crunchbase</a></div>
  <div class="legend-host"><div id="legend" class="custom-legend"></div>
  </div> <a href="https://aiworld.eu" target="_blank" rel="noopener" class="brand-link"> 
  <img src="https://aiworld.eu/logo-transparent.svg" class="brand-logo" alt="AI World logo"> </a> </div>

  
</div>
<!-- Legend container lives inside footer-bar -->
<div class="tooltip" id="tip" aria-hidden="true"></div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
/* ======= 1) Tus datos ======= */
const data = [
  {
    "id": "Lambda (US)",
    "country": "United States",
    "value": 1500000000,
    "category": "Data & Cloud",
    "x_val": 1,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/e65a6737f2aa40e09264679391a0cf27"
  },
  {
    "id": "Kalshi (US)",
    "country": "United States",
    "value": 1000000000,
    "category": "Finance",
    "x_val": 3,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/ec5c28ed28434dc6a8a26c2bf8303167"
  },
  {
    "id": "HyperVault AI Data Center (IN)",
    "country": "India",
    "value": 1000000000,
    "category": "Data & Cloud",
    "x_val": 2,
    "logo": 0
  },
  {
    "id": "Luma AI (US)",
    "country": "United States",
    "value": 900000000,
    "category": "Software",
    "x_val": 4,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/dde1c09fae9647e089c7741a7ab1fd96"
  },
  {
    "id": "Physical Intelligence (US)",
    "country": "United States",
    "value": 600000000,
    "category": "Industry & Mobility",
    "x_val": 5,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/ojqzz3cb7rauvtlt9zzv"
  },
  {
    "id": "Genspark (US)",
    "country": "United States",
    "value": 275000000,
    "category": "Data & Cloud",
    "x_val": 6,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/6becf17c1e5b409385733df3f3be37de"
  },
  {
    "id": "Suno (US)",
    "country": "United States",
    "value": 250000000,
    "category": "Software",
    "x_val": 7,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/gflnhgzhx7iiqhpceraa"
  },
  {
    "id": "Sakana AI (JP)",
    "country": "Japan",
    "value": 129281563,
    "category": "Software",
    "x_val": 8,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/rhfchb7uf4yrnazoucmh"
  },
  {
    "id": "NestAI (US)",
    "country": "United States",
    "value": 115129117,
    "category": "Software",
    "x_val": 9,
    "logo": 0
  },
  {
    "id": "Profluent Bio (US)",
    "country": "United States",
    "value": 106000000,
    "category": "Health",
    "x_val": 10,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/eqz2hj0qtqkqhci29zwi"
  },
  {
    "id": "Federato (US)",
    "country": "United States",
    "value": 100000000,
    "category": "Finance",
    "x_val": 11,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/07b4581be4c747b881c21af968ee66c6"
  },
  {
    "id": "RapidSOS (US)",
    "country": "United States",
    "value": 100000000,
    "category": "Software",
    "x_val": 12,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/6f067764e08c46cc841ff5be91ac2ddb"
  },
  {
    "id": "Doppel (US)",
    "country": "United States",
    "value": 70000000,
    "category": "Cybersecurity",
    "x_val": 13,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/61773922360b404fbd46a988fd45d821"
  },
  {
    "id": "Arbiter (US)",
    "country": "United States",
    "value": 52000000,
    "category": "Health",
    "x_val": 14,
    "logo": 0
  },
  {
    "id": "Numeric (US)",
    "country": "United States",
    "value": 51000000,
    "category": "Finance",
    "x_val": 15,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/qam8sg70xwyebwth0p3u"
  },
  {
    "id": "Flexion Robotics (CH)",
    "country": "Switzerland",
    "value": 50000000,
    "category": "Industry & Mobility",
    "x_val": 16,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/d5faee17bffb46ff9e99a1a9b2a0a44a"
  },
  {
    "id": "Zhijian Power (CN)",
    "country": "China",
    "value": 50000000,
    "category": "Software",
    "x_val": 17,
    "logo": 0
  },
  {
    "id": "aviva (MX)",
    "country": "Mexico",
    "value": 50000000,
    "category": "Data & Cloud",
    "x_val": 18,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/b34fd73568b34ce4a875b069f6eeda41"
  },
  {
    "id": "Sortera Technologies (US)",
    "country": "United States",
    "value": 45000000,
    "category": "Industry & Mobility",
    "x_val": 19,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/rcoo11pvl5ep32657xvp"
  },
  {
    "id": "Netomi (US)",
    "country": "United States",
    "value": 42999977,
    "category": "Software",
    "x_val": 20,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/diuqatwj3klm4uvoabox"
  },
  {
    "id": "Sorcero (US)",
    "country": "United States",
    "value": 42500000,
    "category": "Health",
    "x_val": 21,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/a50d7c4d57d9455ba3d2dfd9ee5fbbec"
  },
  {
    "id": "AI Proteins (US)",
    "country": "United States",
    "value": 41530000,
    "category": "Health",
    "x_val": 22,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/ap8hfbq0k0ryggcpchxb"
  },
  {
    "id": "Agentio (US)",
    "country": "United States",
    "value": 40000000,
    "category": "Software",
    "x_val": 23,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/7bfc1ee474c5479d8568ad2f07b11a88"
  },
  {
    "id": "Chargeflow (IL)",
    "country": "Israel",
    "value": 35000000,
    "category": "Finance",
    "x_val": 24,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/2ff53eab7e11442fbe9eba8b5775cc8c"
  },
  {
    "id": "Archetype AI (US)",
    "country": "United States",
    "value": 35000000,
    "category": "Software",
    "x_val": 25,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/gvitcj6xzuhtnwhfv2jv"
  },
  {
    "id": "Stuut (US)",
    "country": "United States",
    "value": 29500000,
    "category": "Finance",
    "x_val": 26,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/0dd9e8d48f7f4cf0b9be1cc81ea80be4"
  },
  {
    "id": "GetVocal AI (FR)",
    "country": "France",
    "value": 26000000,
    "category": "Software",
    "x_val": 27,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/vn26dsywanyugaqtmnnz"
  },
  {
    "id": "Bedrock Data (fka Bedrock Security) (US)",
    "country": "United States",
    "value": 25000000,
    "category": "Data & Cloud",
    "x_val": 28,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/8e522531843647548cfcc8c2ac1f9858"
  },
  {
    "id": "PowerLattice Technologies (US)",
    "country": "United States",
    "value": 25000000,
    "category": "Software",
    "x_val": 29,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/a79d5f38240d425d98710ba1bc1740e3"
  },
  {
    "id": "Wispr Flow (US)",
    "country": "United States",
    "value": 25000000,
    "category": "Software",
    "x_val": 30,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/5bb12109169948cf8beb6f82a7f288ab"
  },
  {
    "id": "Sphere (US)",
    "country": "United States",
    "value": 21000000,
    "category": "Finance",
    "x_val": 31,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/62fb53a7d8834353b9e120aa95a811ad"
  },
  {
    "id": "Peec AI (DE)",
    "country": "Germany",
    "value": 21000000,
    "category": "Data & Cloud",
    "x_val": 32,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/2cefa39b5f094c44a814ccb2b74729ed"
  },
  {
    "id": "PhysicsX (GB)",
    "country": "United Kingdom",
    "value": 20000000,
    "category": "Software",
    "x_val": 33,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/6b0564c1ec9c4572b72a11a5d11f48f7"
  },
  {
    "id": "OpenHands (US)",
    "country": "United States",
    "value": 18800000,
    "category": "Software",
    "x_val": 34,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/fa3ad215bfbb4cbe85790f0c037d16f0"
  },
  {
    "id": "NcodiN (FR)",
    "country": "France",
    "value": 18420659,
    "category": "Industry & Mobility",
    "x_val": 35,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/cpkudwddh8iy8abpmfsw"
  },
  {
    "id": "AKA FOODS (IL)",
    "country": "Israel",
    "value": 17200000,
    "category": "Industry & Mobility",
    "x_val": 36,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/fkpuylonyrtegxbsgpwd"
  },
  {
    "id": "Coverbase (US)",
    "country": "United States",
    "value": 16500000,
    "category": "Cybersecurity",
    "x_val": 37,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/8c4334cf1a1f4aaa8cd7a49f0d12ad2e"
  },
  {
    "id": "Mate (IL)",
    "country": "Israel",
    "value": 15500000,
    "category": "Software",
    "x_val": 38,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/a2de04718bc74704900dd3bc54cf9b0c"
  },
  {
    "id": "Automat AI (US)",
    "country": "United States",
    "value": 15500000,
    "category": "Software",
    "x_val": 39,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/iccwxoa724rskdgwb9g2"
  },
  {
    "id": "DAIM Research (KR)",
    "country": "South Korea",
    "value": 14990624,
    "category": "Industry & Mobility",
    "x_val": 40,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/kj4j5pbt5qiwzc7gua6m"
  },
  {
    "id": "Estie (JP)",
    "country": "Japan",
    "value": 14220972,
    "category": "Industry & Mobility",
    "x_val": 41,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/8eb5159ba9ab4685aefc6d07070bfe37"
  },
  {
    "id": "Booster Robotics (CN)",
    "country": "China",
    "value": 14072615,
    "category": "Industry & Mobility",
    "x_val": 42,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/44bc56aeae714d0ab17e8d8220a31d22"
  },
  {
    "id": "Xinshengji Intelligence (CN)",
    "country": "China",
    "value": 14061138,
    "category": "Industry & Mobility",
    "x_val": 43,
    "logo": 0
  },
  {
    "id": "Onepot.ai (US)",
    "country": "United States",
    "value": 13000000,
    "category": "Software",
    "x_val": 44,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/4cb9e5768ac840f799855e4c2fadc316"
  },
  {
    "id": "Albatross AI (CH)",
    "country": "Switzerland",
    "value": 12500000,
    "category": "Software",
    "x_val": 45,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/5815265bc67748b6acc03c4cd6da2172"
  },
  {
    "id": "Hammerhead AI (US)",
    "country": "United States",
    "value": 10000000,
    "category": "Industry & Mobility",
    "x_val": 46,
    "logo": 0
  },
  {
    "id": "Voio (US)",
    "country": "United States",
    "value": 8600000,
    "category": "Software",
    "x_val": 47,
    "logo": 0
  },
  {
    "id": "Vurvey Labs (US)",
    "country": "United States",
    "value": 8500000,
    "category": "Industry & Mobility",
    "x_val": 48,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/d313886db7b446b58312036da31b9321"
  },
  {
    "id": "Onlayer (TR)",
    "country": "Turkey",
    "value": 8200000,
    "category": "Finance",
    "x_val": 49,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/ce1f4d8d4cda4f079b9a0257ed2b8046"
  },
  {
    "id": "Dabeeo (KR)",
    "country": "South Korea",
    "value": 8169073,
    "category": "Industry & Mobility",
    "x_val": 50,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/d722feb41e7a44998ab48ff8d12de50a"
  },
  {
    "id": "Poly (US)",
    "country": "United States",
    "value": 8000000,
    "category": "Data & Cloud",
    "x_val": 51,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/rgcpvpcjmebwuk4ntww9"
  },
  {
    "id": "alphaXiv (US)",
    "country": "United States",
    "value": 7000000,
    "category": "Industry & Mobility",
    "x_val": 53,
    "logo": 0
  },
  {
    "id": "Pibit (US)",
    "country": "United States",
    "value": 7000000,
    "category": "Finance",
    "x_val": 52,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/rqjov5rs7djwmaa5h3qw"
  },
  {
    "id": "Cavela (US)",
    "country": "United States",
    "value": 6600000,
    "category": "Industry & Mobility",
    "x_val": 54,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/01b265d281fe494fa7a7e8791a5bb2bb"
  },
  {
    "id": "BluePill (US)",
    "country": "United States",
    "value": 6000000,
    "category": "Industry & Mobility",
    "x_val": 55,
    "logo": 0
  },
  {
    "id": "VoiceRun (US)",
    "country": "United States",
    "value": 5499996,
    "category": "Software",
    "x_val": 56,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/6ac0e3be7c3c47a6b63d27376b9341c1"
  },
  {
    "id": "Luminal (US)",
    "country": "United States",
    "value": 5300000,
    "category": "Software",
    "x_val": 57,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/d184b9a18e684812afe35ff256fed62d"
  },
  {
    "id": "Aive (FR)",
    "country": "France",
    "value": 5220139,
    "category": "Software",
    "x_val": 58,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/s9612ni64lkwnmisn2r1"
  },
  {
    "id": "SynthioLabs (US)",
    "country": "United States",
    "value": 5000000,
    "category": "Health",
    "x_val": 59,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/d5e3968399a94bad86d34b967c5c6ad6"
  },
  {
    "id": "OnboardAI (US)",
    "country": "United States",
    "value": 5000000,
    "category": "Data & Cloud",
    "x_val": 60,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/c7801bb67f564a91876c5bf0d7204978"
  },
  {
    "id": "Donnerstag.ai (DE)",
    "country": "Germany",
    "value": 4616150,
    "category": "Finance",
    "x_val": 61,
    "logo": 0
  },
  {
    "id": "MuchBetter (FR)",
    "country": "France",
    "value": 4615740,
    "category": "Software",
    "x_val": 62,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/uv3sgwpctnqv76fxrggy"
  },
  {
    "id": "AI-Stroke (FR)",
    "country": "France",
    "value": 4600000,
    "category": "Health",
    "x_val": 63,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/59d7a73a8a684be4a1b2e1bc8aea6cbe"
  },
  {
    "id": "Meadow AI (US)",
    "country": "United States",
    "value": 4500000,
    "category": "Software",
    "x_val": 64,
    "logo": 0
  },
  {
    "id": "Asseta AI (US)",
    "country": "United States",
    "value": 4200000,
    "category": "Finance",
    "x_val": 65,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/b20eed7a9e464e10ac618707d65d711d"
  },
  {
    "id": "Annie Labs (US)",
    "country": "United States",
    "value": 4000000,
    "category": "Health",
    "x_val": 67,
    "logo": 0
  },
  {
    "id": "Kiid AI (US)",
    "country": "United States",
    "value": 4000000,
    "category": "Cybersecurity",
    "x_val": 66,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/388feeb105b64b1b9a77ad096b09d57f"
  },
  {
    "id": "Coreworks AI (US)",
    "country": "United States",
    "value": 3999999,
    "category": "Finance",
    "x_val": 68,
    "logo": 0
  },
  {
    "id": "Flyway Health (US)",
    "country": "United States",
    "value": 3964991,
    "category": "Health",
    "x_val": 69,
    "logo": 0
  },
  {
    "id": "Kaaj AI (US)",
    "country": "United States",
    "value": 3800000,
    "category": "Finance",
    "x_val": 70,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/27110527711a484d803ab4335585b4fd"
  },
  {
    "id": "La Fraise (FR)",
    "country": "France",
    "value": 3711440,
    "category": "Software",
    "x_val": 71,
    "logo": 0
  },
  {
    "id": "GramEye (JP)",
    "country": "Japan",
    "value": 3644851,
    "category": "Health",
    "x_val": 72,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/h391bq1lsj8n1ztl73vh"
  },
  {
    "id": "Orion (US)",
    "country": "United States",
    "value": 3500000,
    "category": "Data & Cloud",
    "x_val": 73,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/de71f4508a05499c8e83c0b27a00414e"
  },
  {
    "id": "Barker (US)",
    "country": "United States",
    "value": 3500000,
    "category": "Finance",
    "x_val": 74,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/chlkqyafjswmwb94qttf"
  },
  {
    "id": "Siftwell Analytics, Inc. (US)",
    "country": "United States",
    "value": 3500000,
    "category": "Data & Cloud",
    "x_val": 75,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/axtvppnqrhobqgg5auog"
  },
  {
    "id": "The Blue Box Biomedical Solutions (ES)",
    "country": "Spain",
    "value": 3480093,
    "category": "Health",
    "x_val": 76,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/qeeijbjxrim2wcak3dcu"
  },
  {
    "id": "TACMIND (ES)",
    "country": "Spain",
    "value": 2765053,
    "category": "Data & Cloud",
    "x_val": 77,
    "logo": 0
  },
  {
    "id": "No Barrier (US)",
    "country": "United States",
    "value": 2700000,
    "category": "Health",
    "x_val": 78,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/2c7368344a6a4ea0a33d8cbae5aaf072"
  },
  {
    "id": "Clado (US)",
    "country": "United States",
    "value": 2000000,
    "category": "Software",
    "x_val": 79,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/20ec4e0164e34c5887b8b87436a44d32"
  },
  {
    "id": "Logistica OS (DE)",
    "country": "Germany",
    "value": 1731056,
    "category": "Industry & Mobility",
    "x_val": 80,
    "logo": 0
  },
  {
    "id": "QuantHUB (US)",
    "country": "United States",
    "value": 1444326,
    "category": "Software",
    "x_val": 81,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/ngyo16qc8rr2wifp9lbk"
  },
  {
    "id": "Scale Social AI (US)",
    "country": "United States",
    "value": 1300000,
    "category": "Software",
    "x_val": 82,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/50136932d9654bc282e21fe814abdcfa"
  },
  {
    "id": "Teacher’s Buddy (AU)",
    "country": "Australia",
    "value": 1197062,
    "category": "Education",
    "x_val": 83,
    "logo": 0
  },
  {
    "id": "AI Mage (JP)",
    "country": "Japan",
    "value": 1097635,
    "category": "Industry & Mobility",
    "x_val": 84,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/f024081c48ee4a82b3d4c326910c202b"
  },
  {
    "id": "Malum (US)",
    "country": "United States",
    "value": 1012000,
    "category": "Software",
    "x_val": 85,
    "logo": 0
  },
  {
    "id": "SahmAlgo (SA)",
    "country": "Saudi Arabia",
    "value": 1000000,
    "category": "Finance",
    "x_val": 86,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/b219c149f0e649839132573e2b43f084"
  },
  {
    "id": "vibers.ai (KR)",
    "country": "South Korea",
    "value": 750232,
    "category": "Data & Cloud",
    "x_val": 87,
    "logo": 0
  },
  {
    "id": "Findevor (US)",
    "country": "United States",
    "value": 750000,
    "category": "Finance",
    "x_val": 88,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/b17e951e2f6d49bfa2d84ece5057164d"
  },
  {
    "id": "MyChatBot (US)",
    "country": "United States",
    "value": 500000,
    "category": "Software",
    "x_val": 89,
    "logo": 0
  },
  {
    "id": "Novella AI (US)",
    "country": "United States",
    "value": 499494,
    "category": "Software",
    "x_val": 90,
    "logo": 0
  },
  {
    "id": "Hoopr (IN)",
    "country": "India",
    "value": 450839,
    "category": "Software",
    "x_val": 91,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/t9mz4y1zhwmjjcw9gnr2"
  },
  {
    "id": "Doctly AI (US)",
    "country": "United States",
    "value": 352990,
    "category": "Software",
    "x_val": 92,
    "logo": 0
  },
  {
    "id": "Peekaboo Labs (KR)",
    "country": "South Korea",
    "value": 340199,
    "category": "Software",
    "x_val": 93,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/e9895c42517f4bc2ac4baf6be1d68721"
  },
  {
    "id": "Ravity (IN)",
    "country": "India",
    "value": 225591,
    "category": "Industry & Mobility",
    "x_val": 94,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/0568ad6e1ba543dab2c3d27a7dced5bf"
  },
  {
    "id": "Phinge (US)",
    "country": "United States",
    "value": 150000,
    "category": "Health",
    "x_val": 95,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/cffd02611b8d4ae38385bdaeb9659d7b"
  },
  {
    "id": "Electe (IT)",
    "country": "Italy",
    "value": 115404,
    "category": "Software",
    "x_val": 96,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/3f5fad995183464c8627c25c95930324"
  },
  {
    "id": "BalanceAI (GB)",
    "country": "United Kingdom",
    "value": 100000,
    "category": "Software",
    "x_val": 97,
    "logo": 0
  },
  {
    "id": "Ovomind (CH)",
    "country": "Switzerland",
    "value": 62956,
    "category": "Data & Cloud",
    "x_val": 98,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/izg7drilm4vwamenbulk"
  },
  {
    "id": "ZenOwn (CH)",
    "country": "Switzerland",
    "value": 62956,
    "category": "Industry & Mobility",
    "x_val": 99,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/bu2l1tyjwfru2etmozeo"
  },
  {
    "id": "DiPriMa (CH)",
    "country": "Switzerland",
    "value": 62956,
    "category": "Data & Cloud",
    "x_val": 100,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/f9ec0fedd79141f18c21965f9a528672"
  },
  {
    "id": "Irmos technologies (CH)",
    "country": "Switzerland",
    "value": 31031,
    "category": "Industry & Mobility",
    "x_val": 101,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/l90vrt0i8iipdxvh5lfu"
  },
  {
    "id": "Aurjobs (IN)",
    "country": "India",
    "value": 8460,
    "category": "Software",
    "x_val": 102,
    "logo": "https://images.crunchbase.com/image/upload/t_cb-default-original/06bce7bc32c44bf1aace9b3b7679d0c0"
  }
];
/* Mapea country (o id) -> URL del logo (puede ser flag, marca, etc.) */


/* ======= 2) Medidas y contenedor ======= */
const svg = d3.select("#chart");
const W = 900, H = 520;
const m = { top: 16, right: 16, bottom: 16, left: 16 };
const innerW = W - m.left - m.right;
const innerH = H - m.top - m.bottom;

const g = svg.append("g").attr("transform", `translate(${m.left},${m.top})`);

/* ======= 3) Escalas ======= */
const cats = Array.from(new Set(data.map(d => d.category)));

// ======= Colores por categoría =======
// Mapa fijo para colores de cada categoría (ajustable a tu gusto)
const CATEGORY_COLORS = {
  "Education": "#264677",            // azul oscuro
  "Industry & Mobility": "#F49929",  // naranja
  "Software":"#C7544F",     // morado
  "Legal & Compliance": "#279E7B",   // verde
  "Data & Cloud": "#61EBE3",                 // celeste
  "Finance":"#8F78DB" ,              // rojo ladrillo
  "Health": "#FFD35B",               // verde menta
  "Cybersecurity": "#D091D6"         // azul
};
const catColor = c => CATEGORY_COLORS[c] || '#999';
const x = d3.scaleBand().domain(cats).range([0, innerW]).padding(0.25);

const maxVal = d3.max(data, d => d.value) || 1;
const y = d3.scaleSymlog()
  .constant(maxVal / 50)   // “curvatura”; sube/baja para más/menos compresión
  .domain([0, maxVal])
  .range([innerH, 0])
  .nice();

// Tamaño de logo en función de value (raíz para percepción)
// Radio base de los logos (más grande)
const BUBBLE_SCALE = 1.4; // Ajusta (>1 agranda todo manteniendo proporciones)
const r = d3.scaleSqrt().domain([0, maxVal]).range([10, 120]);
const radius = d => r(d.value) * BUBBLE_SCALE;
/* ======= 4) Ejes y grillas ======= */


const xAxis = g.append("g")
  .attr("class", "axis axis--x")
  .attr("transform", `translate(0,${innerH})`)
  .call(d3.axisBottom(x).tickPadding(12)); 
  

    function wrapTicks(selection, width) {
  const lineHeight = 1.1; // en em
  selection.each(function () {
    const text = d3.select(this);
    const words = text.text().split(/\s+/).filter(Boolean);
    text.text(null); // limpiamos el <text>

    let line = [];
    let lineNumber = 0;
    let tspan = text.append("tspan").attr("x", 0).attr("dy", "0em");

    for (const w of words) {
      line.push(w);
      tspan.text(line.join(" "));
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [w];
        tspan = text.append("tspan")
          .attr("x", 0)
          .attr("dy", `${++lineNumber * lineHeight}em`)
          .text(w);
      }
    }
    text.attr("text-anchor","middle");
  });
}

// aplica el wrap usando el ancho de la categoría
xAxis.selectAll("text").call(wrapTicks, x.bandwidth())
xAxis.selectAll("text").remove();
// Oculta/borra los ejes
xAxis.remove();
g.selectAll('.axis').remove();
const fmtShort = d => d3.format(".2s")(d).replace("G","B");

// Y-axis removido
g.append("text").attr("class","label")
  .attr("x", innerW/2).attr("y", innerH + 50).attr("text-anchor","middle").text("");

g.append("text").attr("class","label")
  .attr("x", -innerH/2).attr("y", -50).attr("transform","rotate(-90)").attr("text-anchor","middle").text("");

/* ======= 5) Puntos (logos) — empaquetado por categoría ======= */
const GAP = 0.5;                   // separaci�n m�nima entre logos (px)
const LOGO_PAD = 0.2; // logo inner padding (px)
const SHAPE_FACTOR = Math.SQRT2;
// centro de cada categoría y altura fija (Y sin significado)

// ✅ Nuevo layout en rejilla: posiciones tipo columna.fila (col.row)
const NUM_ROWS = 2;                                  // filas: 1..4
const nCols   = Math.ceil(cats.length / NUM_ROWS);   // cuántas columnas necesitamos
const colW    = innerW / nCols;                      // ancho de cada columna
const rowH    = innerH / NUM_ROWS;                   // alto de cada fila

// Mapa categoría -> {col, row} siguiendo el orden en 'cats'
const catPos = new Map(
  cats.map((c, i) => [c, { col: Math.floor(i / NUM_ROWS), row: i % NUM_ROWS }])
);

// Offsets manuales por categoría para ajustar posición de grupos
// Edita los valores dx/dy en píxeles según necesites.
const groupOffset = {
  "Data & Cloud": {
    "dx": 120,
    "dy": 0
  },
  "Finance": {
    "dx": 20,
    "dy": -50
  },
  "Software": {
    "dx": 150,
    "dy":10
  },
  "Industry & Mobility": {
    "dx": 15,
    "dy": -45
  },
  "Health": {
    "dx": 135,
    "dy": 35
  },
  "Cybersecurity": {
    "dx": 25,
    "dy": -35
  },
  "Education": {
    "dx": 70,
    "dy": 30
  }
};

const getOffset = (cat) => (groupOffset[cat] || { dx: 0, dy: 0 });

// Title vertical offsets (px) per category
const TITLE_OFFSET_Y = {
  "Data & Cloud": 17,
  "Finance": 184,
  "Software": 10,
  "Industry & Mobility": 200,
  "Health": 10,
  "Cybersecurity": 171,
  "Education": 100
};
// Centros del racimo por categoría (columna.fila → píxeles)
const xCenter = d => {
  const { col } = catPos.get(d.category);
  return col * colW + colW / 2;
};
const yCenter = cat => {
  const { row } = catPos.get(cat);
  return row * rowH + rowH / 2;
};

// 1) agrupa datos por categoría
const groups = d3.group(data, d => d.category);
const clusterH = Math.min(rowH * 1.2, 400); // se adapta a la fila
  g.selectAll(".cluster-title")
  .data(cats)                               // ← un texto por categoría
  .join("text")
  .attr("class", "cluster-title")
  .attr("x", d => x(d) + x.bandwidth()/2)   // centro de la banda
  .attr("y", d => yCenter(d) - clusterH/2 + 30 + (TITLE_OFFSET_Y[d] || 0)) // arriba del racimo
  .attr("text-anchor", "middle")
  .text(d => d); 
// Reposiciona títulos aplicando offsets manuales
g.selectAll(".cluster-title").attr("x", d => {
  const p = catPos.get(d);
  const base = (p.col * colW) + (colW / 2);
  const { dx } = getOffset(d);
  return base + dx;
});
// 2) para cada grupo, calcula un layout compacto sin solapes
for (const [cat, arr] of groups) {
  // construye círculos con el radio visual (radius(d))
  const circles = arr.map(d => ({ d, r: radius(d) + GAP + 1}));

  // coloca los círculos locales (x,y) sin superposición
  d3.packSiblings(circles); // muta: c.x, c.y y respeta c.r

  // 3) escala el racimo para que quepa dentro del ancho de la banda
  const pad = 0;
  const maxX = d3.max(circles, c => Math.abs(c.x) + c.r) || 1;
  const maxY = d3.max(circles, c => Math.abs(c.y) + c.r) || 1;

  // altura máxima opcional del racimo (ajusta a gusto)
  
  const sx = (colW/2 - pad) / maxX;
  const sy = (clusterH/2 - pad) / maxY;
  const s = Math.min(sx, sy, 1); // evita agrandar clusters pequeños


  // guarda posiciones y radio escalados por dato (evita solapes)
  circles.forEach(c => {
    c.d._px = c.x * s;
    c.d._py = c.y * s;
    c.d._r  = radius(c.d) * s;
  });

}// 4) dibuja las imágenes en su categoría con el offset del racimo
const nodes = g.selectAll(".dot")
  .data(data)
  .join("image")
  .attr("class","dot")
  .attr("href", d => d.logo || "")
  .attr("data-category", d => d.category)
  .attr("display", d => hasLogo(d) ? null : 'none')
  .attr("width", d => (d._r - LOGO_PAD) * 2)
  .attr("height", d => (d._r - LOGO_PAD) * 2)
  .attr("preserveAspectRatio","xMidYMid meet")
  .attr("x", d => xCenter(d) + (getOffset(d.category).dx || 0) + (d._px ?? 0) - (d._r - LOGO_PAD))
  .attr("y", d => yCenter(d.category) + (getOffset(d.category).dy || 0) + (d._py ?? 0) - (d._r - LOGO_PAD))
  .on("mousemove", (event, d) => {
      tip.style.opacity = 1;
      tip.style.left = (event.clientX + 12) + "px";
      tip.style.top  = (event.clientY + 12) + "px";
      tip.innerHTML = `<strong>${d.id}</strong><br>${d.country}<br>${d.category}<br>Value: ${new Intl.NumberFormat().format(d.value)}`;
  })
  .on("mouseleave", () => { tip.style.opacity = 0; });

// Usa c�rculos: contorno + recorte circular del logo
g.selectAll("image.dot").each(function(d, i){
  const sel = d3.select(this);
  const baseR = d._r;
  const cx = xCenter(d) + (getOffset(d.category).dx || 0) + (d._px ?? 0);
  const cy = yCenter(d.category) + (getOffset(d.category).dy || 0) + (d._py ?? 0);
  const rad = baseR;

  // Guarda posiciones originales para restaurar luego del enfoque
  d._cx = cx;
  d._cy = cy;
  d._r = baseR;

  // c�rculo de fondo con borde negro
  d3.select(this.parentNode)
    .insert("circle", () => this)
      .attr("class", "logo-circle")
      .datum(d)
      .attr("cx", cx)
      .attr("cy", cy)
      .attr("r", rad)
      .attr("fill", hasLogo(d) ? "#fff" : catColor(d.category))
      .attr("stroke", catColor(d.category))
      .attr("stroke-width", 2.4)
      .attr("data-category", d.category);

  // recorte circular para la imagen
  const defs = svg.select("defs").empty() ? svg.append("defs") : svg.select("defs");
  const clipId = "clip-" + i;
  d._clipId = clipId;
  const cp = defs.select("#" + clipId).empty() ? defs.append("clipPath").attr("id", clipId) : defs.select("#" + clipId);
  cp.selectAll("circle").data([null]).join("circle")
    .attr("cx", cx)
    .attr("cy", cy)
    .attr("r", rad);
  sel.attr("clip-path", "url(#" + clipId + ")");
});

// Interacciones para círculos (fallback cuando no hay logo)
g.selectAll('circle.logo-circle')
  .on('mousemove', (event, d) => {
    tip.style.opacity = 1;
    tip.style.left = (event.clientX + 12) + 'px';
    tip.style.top  = (event.clientY + 12) + 'px';
    tip.innerHTML = `<strong>${d.id}</strong><br>${d.country}<br>Category: ${d.category}<br>Value: ${new Intl.NumberFormat().format(d.value)}`;
  })
  .on('mouseleave', () => { tip.style.opacity = 0; });

// ======= 5.5) Branding y fuente =======
// Se usa la barra inferior (.footer-bar) para logo y Source.

// ======= Legend (mistral-style) =======
const catsForLegend = [...cats].sort((a,b)=>a.localeCompare(b));
const activeCats = new Set(cats);
const FOCUS_SCALE = 0.65; // 1.0 = llena más, <1.0 = más pequeño
let focusedCat = null; // categoría enfocada (o null)

// Enfoca una categoría: oculta el resto, centra y agranda
const FOCUS_TITLE_SIZE = 20; // px, title size when focused
function focusCategory(cat){
  focusedCat = cat;
  activeCats.clear();
  activeCats.add(cat);

  const arr = groups.get(cat) || [];
  if(!arr.length){ updateVisibility(); return; }

  // Empaqueta usando radios base y escala para ocupar el área disponible
  const circles = arr.map(d => ({ d, r: radius(d) + GAP + 1 }));
  d3.packSiblings(circles);
  const pad = 10;
  const maxX = d3.max(circles, c => Math.abs(c.x) + c.r) || 1;
  const maxY = d3.max(circles, c => Math.abs(c.y) + c.r) || 1;
  const sx = ((innerW / 2) - pad) / maxX;
  const sy = ((innerH / 2) - pad) / maxY;
  const s  = Math.min(sx, sy) * FOCUS_SCALE;

  circles.forEach(c => {
    c.d.__fx = c.x * s;
    c.d.__fy = c.y * s;
    c.d.__fr = radius(c.d) * s;
  });

  const cx0 = innerW / 2;
  const cy0 = innerH / 2;
  const t = svg.transition().duration(450).ease(d3.easeCubicOut);

  // Actualiza imágenes de la categoría enfocada
  svg.selectAll('image.dot')
    .filter(d => d.category === cat)
    .transition(t)
    .attr('width',  d => (d.__fr - LOGO_PAD) * 2)
    .attr('height', d => (d.__fr - LOGO_PAD) * 2)
    .attr('x',      d => cx0 + (d.__fx || 0) - (d.__fr - LOGO_PAD))
    .attr('y',      d => cy0 + (d.__fy || 0) - (d.__fr - LOGO_PAD));

  // Actualiza círculos de borde
  svg.selectAll('circle.logo-circle')
    .filter(d => d.category === cat)
    .transition(t)
    .attr('cx', d => cx0 + (d.__fx || 0))
    .attr('cy', d => cy0 + (d.__fy || 0))
    .attr('r',  d => d.__fr);

  // Actualiza clipPaths para mantener recorte circular correcto
  arr.forEach(d => {
    if(!d._clipId) return;
    svg.select('#' + d._clipId + ' circle')
      .transition(t)
      .attr('cx', cx0 + (d.__fx || 0))
      .attr('cy', cy0 + (d.__fy || 0))
      .attr('r',  d.__fr);
  });

  // Muestra y reposiciona el título de la categoría enfocada por encima del racimo
  const minBound = d3.min(arr, d => (d.__fy || 0) - (d.__fr || 0)) || 0;
  const titleY = cy0 + minBound - 12; // margen superior del racimo
  svg.selectAll('.cluster-title')
    .attr('display', d => d === cat ? null : 'none')
    .filter(d => d === cat)
    .transition(t)
    .attr('x', cx0)
    .attr('y', titleY)
    .style('font-size', FOCUS_TITLE_SIZE + 'px');

  // Calcula el total y ubícalo centrado apenas por encima de la leyenda (footer-bar)
  const total = d3.sum(arr, d => d.value) || 0;
  const totalLabel = `Total amount: ${fmtShort(total)}`;

  // Convertir coordenadas de pantalla a coordenadas del grupo `g` dentro del viewBox
  const footer = document.querySelector('.footer-bar');
  const svgRect = svg.node().getBoundingClientRect();
  const scaleY = H / svgRect.height;
  const marginPx = 25; // separación respecto al borde superior de la barra
  let totX = (W / 2) - m.left; // centrado en el SVG, compensando el margen izquierdo del grupo
  let totY = innerH - 24;      // fallback si no existe footer-bar
  if (footer) {
    const footRect = footer.getBoundingClientRect();
    const yScreen = Math.max(svgRect.top, footRect.top) - marginPx; // justo encima del footer
    const ySvg = (yScreen - svgRect.top) * scaleY;                   // a coords del viewBox
    totY = Math.max(24, Math.min(innerH - 4, ySvg - m.top));         // a coords del grupo `g`, con límites
  }

  const totalSel = g.selectAll('.cluster-total').data([cat]);
  totalSel
    .join('text')
    .attr('class', 'cluster-total')
    .attr('text-anchor', 'middle')
    .attr('x', totX)
    .attr('y', totY)
    .text(totalLabel)
    .style('opacity', 0)
    .transition(t)
    .style('opacity', 1)
    .attr('x', totX)
    .attr('y', totY);

  updateVisibility();
}

// Quita el foco: restaura posiciones y radios originales y muestra todo
function resetFocus(){
  focusedCat = null;
  activeCats.clear();
  cats.forEach(c => activeCats.add(c));

  const t = svg.transition().duration(400).ease(d3.easeCubicOut);

  svg.selectAll('image.dot')
    .transition(t)
    .attr('width',  d => (d._r - LOGO_PAD) * 2)
    .attr('height', d => (d._r - LOGO_PAD) * 2)
    .attr('x',      d => (d._cx ?? 0) - (d._r - LOGO_PAD))
    .attr('y',      d => (d._cy ?? 0) - (d._r - LOGO_PAD));

  svg.selectAll('circle.logo-circle')
    .transition(t)
    .attr('cx', d => d._cx ?? 0)
    .attr('cy', d => d._cy ?? 0)
    .attr('r',  d => d._r);

  data.forEach(d => {
    if(!d._clipId) return;
    svg.select('#' + d._clipId + ' circle')
      .transition(t)
      .attr('cx', d._cx ?? 0)
      .attr('cy', d._cy ?? 0)
      .attr('r',  d._r);
  });

  // Restaura títulos a su posición original y vuelve a mostrarlos
  svg.selectAll('.cluster-title')
    .transition(t)
    .attr('x', d => {
      const p = catPos.get(d);
      const base = (p.col * colW) + (colW / 2);
      const { dx } = getOffset(d);
      return base + dx;
    })
    .attr('y', d => yCenter(d) - clusterH/2 + 30 + (TITLE_OFFSET_Y[d] || 0))
    .attr('display', null)
    .style('font-size', null);

  // Oculta y elimina el total al salir del foco
  svg.selectAll('.cluster-total')
    .transition(t)
    .style('opacity', 0)
    .remove();

  updateVisibility();
}
function hasLogo(d){
  const v = d && d.logo;
  if (v === null || v === undefined || v === 0) return false;
  if (typeof v === 'string') {
    const s = v.trim();
    if (s === '' || s === '0') return false;
    return true;
  }
  return !!v;
}
function buildLegend(){
  const legend = document.getElementById('legend');
  if(!legend) return;
  legend.innerHTML = '';
  catsForLegend.forEach(cat => {
    const item = document.createElement('div');
    item.className = 'legend-item active';
    item.setAttribute('data-category', cat);
    item.setAttribute('role','button');
    item.setAttribute('tabindex','0');
    item.setAttribute('aria-pressed','true');
    const square = document.createElement('div');
    square.className = 'legend-square';
    square.style.backgroundColor = catColor(cat);
    const label = document.createElement('span');
    label.textContent = cat;
    item.appendChild(square);
    item.appendChild(label);
    const toggle = () => {
      if (focusedCat === cat) {
        resetFocus();
      } else {
        focusCategory(cat);
      }
    };
    item.addEventListener('click', toggle);
    item.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(); }});
    legend.appendChild(item);
  });
}
function updateVisibility(){
  // Update nodes and circles
  const show = cat => activeCats.has(cat);
  svg.selectAll('image.dot').attr('display', function(d){
    const cat = this.getAttribute('data-category');
    return (show(cat) && hasLogo(d)) ? null : 'none';
  });
  svg.selectAll('circle.logo-circle').attr('display', function(){
    const cat = this.getAttribute('data-category');
    return show(cat) ? null : 'none';
  });
  // Títulos: si hay foco (una sola activa) muestra solo esa; si no, sigue el filtro
  const single = activeCats.size === 1;
  if (single) {
    const only = Array.from(activeCats)[0];
    svg.selectAll('.cluster-title').attr('display', function(){
      const c = this.__data__;
      return c === only ? null : 'none';
    });
  } else {
    svg.selectAll('.cluster-title').attr('display', function(){
      const c = this.__data__;
      return show(c) ? null : 'none';
    });
  }
  // Update legend classes
  document.querySelectorAll('.legend-item').forEach(el => {
    const cat = el.getAttribute('data-category');
    const isActive = activeCats.has(cat);
    el.classList.toggle('inactive', !isActive);
    el.classList.toggle('active', isActive);
    el.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
}
buildLegend();
updateVisibility();
/* ======= 6) Responsivo ======= */
/* Ya no necesitamos JS para altura: el viewBox + CSS height:100% se encargan */
</script>
</body>
</html>
