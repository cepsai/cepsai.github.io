<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <style type="text/css">
    .knitr .inline {
      background-color: #F7F7F7;
      border: solid 1px #B0B0B0;
    }

    .error {
      font-weight: bold;
      color: #FF0000;
    }

    .warning {
      font-weight: bold;
    }

    .message {
      font-style: italic;
    }

    .source,
    .output,
    .warning,
    .error,
    .message {
      padding: 0 1em;
      border: solid 1px #F7F7F7;
    }

    .source {
      background-color: #F5F5F5;
    }

    .rimage .left {
      text-align: left;
    }

    .rimage .right {
      text-align: right;
    }

    .rimage .center {
      text-align: center;
    }

    body {
      margin: 0;
      overflow: hidden;
      height: 100vh;
      font-family: Arial, sans-serif;
      background-color: white;
    }

    .viz-grid {
      display: grid;
      grid-template-rows: 16fr 1fr 2fr 1fr;
      grid-template-columns: 1fr 1fr;
      height: 100vh;
      width: 100vw;
      box-sizing: border-box;
      padding-bottom: clamp(8px, 2vh, 18px);
    }

    #container1 {
      grid-row: 1;
      grid-column: 1 / span 2;
      overflow: hidden;
      min-height: 0;
    }

    #container5 {
      grid-row: 2;
      grid-column: 1 / span 2;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 20px;
      overflow: hidden;
    }

    #container2 {
      grid-row: 3;
      grid-column: 1 / span 2;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #container3 {
      grid-row: 4;
      grid-column: 1;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0 20px;
      overflow: hidden;
      min-width: 0;
    }

    #container4 {
      grid-row: 4;
      grid-column: 2;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      overflow: hidden;
      min-width: 0;
      gap: 20px;
    }

    #container4 a {
      height: 100%;
      display: flex;
      align-items: center;
    }

    #viz {
      width: 100%;
      height: 100%;
      min-height: 0;
      min-width: 0;
    }

    .custom-legend {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: clamp(4px, 1vw, 10px);
      padding: clamp(2px, 0.5vh, 4px) clamp(4px, 0.8vw, 8px);
      overflow: auto;
      max-width: 100%;
      max-height: 100%;
      font-size: clamp(8px, 1.3vw, 13px);
      font-weight: 600;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: opacity 0.2s ease;
      font-weight: 600;
      color: #333;
      position: relative;
    }

    .legend-item.inactive {
      opacity: 0.35;
    }

    .legend-square {
      width: clamp(10px, 1.2vw, 14px);
      height: clamp(10px, 1.2vw, 14px);
      border-radius: 4px;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.15) inset;
    }

    .legend-item:focus-visible {
      outline: 2px solid rgba(0, 0, 0, 0.5);
      outline-offset: 2px;
    }

    .logo {
      height: 100%;
      width: auto;
      max-height: 100%;
      max-width: 100%;
      pointer-events: auto;
      object-fit: contain;
    }

    .source-text {
      font-size: clamp(10px, 1.6vw, 16px);
      font-weight: 600;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      font-style: normal;
    }

    .source-text a {
      color: #2756d3;
      text-decoration: underline;
      cursor: pointer;
      font-style: normal;
    }

    .source-text a:visited {
      color: #2756d3;
    }

    .footnote-text {
      font-size: clamp(10px, 1.6vw, 16px);
      font-style: italic;
      color: #333;
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .selector-group {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      gap: clamp(2px, 0.5vw, 6px);
      padding: clamp(2px, 0.4vw, 4px);
      border-radius: 6px;
      border: 1px solid rgba(17, 24, 39, 0.15);
      background: #f8fafc;
      max-width: 100%;
      flex-shrink: 1;
      min-width: 0;
    }

    .selector-button {
      border: none;
      background: transparent;
      padding: clamp(4px, 0.8vh, 8px) clamp(8px, 1.5vw, 14px);
      border-radius: 6px;
      font-size: clamp(9px, 1.4vw, 13px);
      font-weight: 600;
      color: #475569;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
      white-space: nowrap;
      flex-shrink: 1;
      min-width: 0;
    }

    .selector-button.active {
      background: #2756d3;
      color: #fff;
    }

    .selector-label {
      font-size: clamp(8px, 1.2vw, 12px);
      font-weight: 600;
      color: #0f172a;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-right: clamp(2px, 0.4vw, 6px);
      white-space: nowrap;
    }


    @media (max-height: 500px) {
      .viz-grid {
        grid-template-rows: 1fr;
        grid-template-columns: 1fr;
      }

      #container1 {
        grid-row: 1;
        grid-column: 1;
      }

      #container2,
      #container3,
      #container4,
      #container5 {
        display: none !important;
      }

      .custom-legend,
      .source-text,
      .logo,
      .footnote-text {
        display: none !important;
      }
    }
  </style>

  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3plus-hierarchy@1"></script>
</head>

<body>
  <div class="viz-grid">
    <div id="container1" class="container viz-container">
      <div id="viz"></div>
    </div>
    <div id="container5" class="container footnote-container">
    </div>
    <div id="container2" class="container legend-container">
      <div class="custom-legend" id="legend"></div>
    </div>
    <div id="container3" class="container source-container">
      <div class="source-text" id="source-text">
    Source: <a href="https://huggingface.co/spaces/AIEnergyScore/Leaderboard" target="_blank" rel="noopener noreferrer">AI Energy Score Leaderboard</a>
  </div>
    </div>
    <div id="container4" class="container logo-container">
      <div class="selector-group">
        <button class="selector-button active" data-view="2025">2025</button>
        <button class="selector-button" data-view="2024">2024</button>
        <button class="selector-button" data-view="change">% Change</button>
      </div>
      <a href="https://aiworld.eu/" id="logo-link" target="_blank" rel="noopener">
        <img src="https://aiworld.eu/logo-transparent.svg" class="logo" alt="AI World logo" />
      </a>
    </div>
  </div>

  <script>
    const SHOW_CONTAINER_2 = 0;
    const SHOW_CONTAINER_3 = 1;
    const SHOW_CONTAINER_4 = 1;
    const SHOW_CONTAINER_5 = 0;

    const VIZ_CONTAINER_ID = 'viz';
    const SOURCE_CONTAINER_ID = 'source-text';
    const LOGO_CONTAINER_ID = 'logo-link';
    const FOOTNOTE_CONTAINER_ID = 'footnote-text';

    const vizContainer = document.getElementById(VIZ_CONTAINER_ID);
    const sourceContainer = document.getElementById(SOURCE_CONTAINER_ID);
    const logoContainer = document.getElementById(LOGO_CONTAINER_ID);
    const footnoteContainer = document.getElementById(FOOTNOTE_CONTAINER_ID);

    (function applyContainerVisibility() {
      const vizGrid = document.querySelector('.viz-grid');
      const container1 = document.getElementById('container1');
      const container2 = document.getElementById('container2');
      const container3 = document.getElementById('container3');
      const container4 = document.getElementById('container4');
      const container5 = document.getElementById('container5');

      if (!SHOW_CONTAINER_2) {
        container2.style.display = 'none';
      }
      if (!SHOW_CONTAINER_3) {
        container3.style.display = 'none';
      }
      if (!SHOW_CONTAINER_4) {
        container4.style.display = 'none';
      }
      if (!SHOW_CONTAINER_5) {
        container5.style.display = 'none';
      }

      const row2Visible = SHOW_CONTAINER_5;
      const row3Visible = SHOW_CONTAINER_2;
      const row4Visible = SHOW_CONTAINER_3 || SHOW_CONTAINER_4;

      let gridRows = [];
      let currentRow = 1;

      const container1Height = 20 - (row2Visible ? 1 : 0) - (row3Visible ? 2 : 0) - (row4Visible ? 1 : 0);
      gridRows.push(`${container1Height}fr`);

      if (row2Visible) {
        gridRows.push('1fr');
        currentRow++;
        container5.style.gridRow = currentRow.toString();
      }

      if (row3Visible) {
        gridRows.push('2fr');
        currentRow++;
        container2.style.gridRow = currentRow.toString();
      }

      if (row4Visible) {
        gridRows.push('1fr');
        currentRow++;
        if (SHOW_CONTAINER_3) container3.style.gridRow = currentRow.toString();
        if (SHOW_CONTAINER_4) container4.style.gridRow = currentRow.toString();
      }

      vizGrid.style.gridTemplateRows = gridRows.join(' ');
      container1.style.gridRow = '1';

      if (row4Visible) {
        if (SHOW_CONTAINER_3 && !SHOW_CONTAINER_4) {
          container3.style.gridColumn = '1 / span 2';
        } else if (!SHOW_CONTAINER_3 && SHOW_CONTAINER_4) {
          container4.style.gridColumn = '1 / span 2';
        }
      }
    })();

    const PLOT_TYPE = "bar";
    const languageData = [
  {
    "id": "english",
    "name": "ðŸ‡¬ðŸ‡§ English",
    "value_2024": 94832,
    "value_2025": 146255,
    "percent_change": 54.22536696
  },
  {
    "id": "chinese",
    "name": "ðŸ‡¨ðŸ‡³ Chinese",
    "value_2024": 5447,
    "value_2025": 9548,
    "percent_change": 75.28914999
  },
  {
    "id": "french",
    "name": "ðŸ‡«ðŸ‡· French",
    "value_2024": 5184,
    "value_2025": 8284,
    "percent_change": 59.79938272
  },
  {
    "id": "spanish",
    "name": "ðŸ‡ªðŸ‡¸ Spanish",
    "value_2024": 4981,
    "value_2025": 6928,
    "percent_change": 39.08853644
  },
  {
    "id": "german",
    "name": "ðŸ‡©ðŸ‡ª German",
    "value_2024": 4945,
    "value_2025": 6349,
    "percent_change": 28.39231547
  },
  {
    "id": "japanese",
    "name": "ðŸ‡¯ðŸ‡µ Japanese",
    "value_2024": 4259,
    "value_2025": 5878,
    "percent_change": 38.01361822
  },
  {
    "id": "portuguese",
    "name": "ðŸ‡µðŸ‡¹ Portuguese",
    "value_2024": 4219,
    "value_2025": 5669,
    "percent_change": 34.36833373
  },
  {
    "id": "korean",
    "name": "ðŸ‡°ðŸ‡· Korean",
    "value_2024": 4396,
    "value_2025": 5564,
    "percent_change": 26.56960874
  },
  {
    "id": "italian",
    "name": "ðŸ‡®ðŸ‡¹ Italian",
    "value_2024": 4388,
    "value_2025": 5412,
    "percent_change": 23.33637192
  },
  {
    "id": "russian",
    "name": "ðŸ‡·ðŸ‡º Russian",
    "value_2024": 2977,
    "value_2025": 4391,
    "percent_change": 47.49748069
  },
  {
    "id": "arabic",
    "name": "ðŸ‡¸ðŸ‡¦ Arabic",
    "value_2024": 2221,
    "value_2025": 4195,
    "percent_change": 88.87888339
  },
  {
    "id": "hindi",
    "name": "ðŸ‡®ðŸ‡³ Hindi",
    "value_2024": 2680,
    "value_2025": 3633,
    "percent_change": 35.55970149
  },
  {
    "id": "thai",
    "name": "ðŸ‡¹ðŸ‡­ Thai",
    "value_2024": 2539,
    "value_2025": 3291,
    "percent_change": 29.61795983
  },
  {
    "id": "vietnamese",
    "name": "ðŸ‡»ðŸ‡³ Vietnamese",
    "value_2024": 1743,
    "value_2025": 2979,
    "percent_change": 70.91222031
  },
  {
    "id": "turkish",
    "name": "ðŸ‡¹ðŸ‡· Turkish",
    "value_2024": 1342,
    "value_2025": 2438,
    "percent_change": 81.66915052
  },
  {
    "id": "indonesian",
    "name": "ðŸ‡®ðŸ‡© Indonesian",
    "value_2024": 1581,
    "value_2025": 2230,
    "percent_change": 41.04996837
  },
  {
    "id": "polish",
    "name": "ðŸ‡µðŸ‡± Polish",
    "value_2024": 1453,
    "value_2025": 2212,
    "percent_change": 52.23675155
  },
  {
    "id": "dutch",
    "name": "ðŸ‡³ðŸ‡± Dutch",
    "value_2024": 1254,
    "value_2025": 2018,
    "percent_change": 60.92503987
  },
  {
    "id": "romanian",
    "name": "ðŸ‡·ðŸ‡´ Romanian",
    "value_2024": 986,
    "value_2025": 1712,
    "percent_change": 73.63083164
  },
  {
    "id": "ukrainian",
    "name": "ðŸ‡ºðŸ‡¦ Ukrainian",
    "value_2024": 762,
    "value_2025": 1688,
    "percent_change": 121.5223097
  },
  {
    "id": "swedish",
    "name": "ðŸ‡¸ðŸ‡ª Swedish",
    "value_2024": 713,
    "value_2025": 1549,
    "percent_change": 117.2510519
  }
];

    let currentView = "2025";

    function getOriginalData() {
      return languageData.map(function(d) {
        let value;
        if (currentView === "2025") {
          value = d.value_2025;
        } else if (currentView === "2024") {
          value = d.value_2024;
        } else {
          value = d.percent_change;
        }
        return {
          id: d.id,
          name: d.name,
          value: value
        };
      });
    }

    let originalData = getOriginalData();
    const TREEMAP_BORDER_RADIUS = 6;
    const TREEMAP_SHOW_VALUES = 0;
    const BAR_BORDER_RADIUS = 0;
    const BAR_USE_GRADIENT = 1;
    const BAR_VALUE_POSITION = "outside";
    const BAR_ORIENTATION = "horizontal";
    const BAR_COLOR_BY_GROUP = 0;
    const PALETTE_MODE = "aiw";

    function normalizeData(arr) {
      return arr.map(function (d) {
        var parent = d.parent || d.group || d.domain || d.category || d.type || d.class;
        var name = d.name || d.id || d.label || d.title;
        var value = (d.value != null) ? +d.value : (d.count != null) ? +d.count : (d.size != null) ? +d.size : 0;
        var color = d.color != null ? d.color : null;
        return { parent: parent, name: name, value: value, color: color };
      });
    }

    let treemapData = normalizeData(originalData);
    const groups = Array.from(new Set(treemapData.map(function (d) { return d.parent; })));
    const inferredColors = {};
    groups.forEach(function (g) {
      var item = originalData.find(function (x) {
        var p = x.parent || x.group || x.domain || x.category || x.type || x.class;
        return p === g;
      });
      inferredColors[g] = item && item.color ? item.color : null;
    });

    const fallbackPalette = ["#1F77B4", "#FF7F0E", "#2CA02C", "#9467BD", "#D62728", "#17BECF", "#8C564B", "#E377C2", "#7F7F7F", "#BCBD22"];
    const groupColors = {};
    groups.forEach(function (g, i) {
      var baseColor;
      if (inferredColors[g]) baseColor = inferredColors[g];
      else if (PALETTE_MODE === "aiw") baseColor = "#2756d3";
      else if (PALETTE_MODE === "ceps") baseColor = "#207164";
      else baseColor = fallbackPalette[i % fallbackPalette.length];
      groupColors[g] = baseColor;
    });

    const activeGroups = new Set(groups);

    function getGroupColor(parent) {
      var c = groupColors[parent];
      if (!c && (PALETTE_MODE === "aiw" || PALETTE_MODE === "ceps")) {
        return PALETTE_MODE === "aiw" ? "#2756d3" : "#207164";
      }
      return c || "#666666";
    }

    let legendInitialized = false;

    function getLegendElement() {
      var legend = document.getElementById("legend");
      if (legend) return legend;
      var legendContainer = document.getElementById("container2");
      if (!legendContainer) return null;
      legend = document.createElement("div");
      legend.id = "legend";
      legend.className = "custom-legend";
      legendContainer.appendChild(legend);
      return legend;
    }

    function buildLegend() {
      if (legendInitialized) return;
      var legend = getLegendElement();
      if (!legend) return;
      legend.innerHTML = "";
      groups.forEach(function (g) {
        var item = document.createElement("div");
        item.className = "legend-item active";
        item.setAttribute("data-group", g);
        item.setAttribute("role", "button");
        item.setAttribute("tabindex", "0");
        item.setAttribute("aria-pressed", "true");

        var square = document.createElement("div");
        square.className = "legend-square";
        square.style.backgroundColor = getGroupColor(g);
        square.style.borderRadius = TREEMAP_BORDER_RADIUS + "px";

        var label = document.createElement("span");
        label.textContent = g;

        item.appendChild(square);
        item.appendChild(label);

        var toggleGroup = function () {
          if (activeGroups.has(g)) {
            activeGroups.delete(g);
          } else {
            activeGroups.add(g);
          }
          updateVisualization();
        };

        item.addEventListener("click", toggleGroup);
        item.addEventListener("keydown", function (e) {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            toggleGroup();
          }
        });

        legend.appendChild(item);
      });
      legendInitialized = true;
    }

    function updateLegendStyles() {
      var legend = document.getElementById("legend");
      if (!legend) return;
      var items = legend.querySelectorAll(".legend-item");
      items.forEach(function (item) {
        var grp = item.getAttribute("data-group");
        var isActive = activeGroups.has(grp);
        item.classList.toggle("inactive", !isActive);
        item.classList.toggle("active", isActive);
        item.setAttribute("aria-pressed", isActive ? "true" : "false");
      });
    }

    let treemapInstance = null;
    let barSvg = null;
    let barTooltip = null;

    function ensureTreemapInstance(width, height) {
      if (!vizContainer) return null;
      if (!treemapInstance) {
        treemapInstance = new d3plus.Treemap()
          .select("#" + VIZ_CONTAINER_ID)
          .data(treemapData)
          .groupBy(["parent", "name"])
          .tooltipConfig({
            title: function (d) { return d.name; },
            body: function (d) {
              var sector = d.parent || d.id;
              var count = d.value || 0;
              return "<strong>Sector:</strong> " + sector + "<br><strong>Count:</strong> " + count;
            }
          })
          .sum("value")
          .layoutPadding(2)
          .legend(false)
          .color(function (d) {
            return getGroupColor(d.parent || d.id);
          })
          .shapeConfig({
            rx: TREEMAP_BORDER_RADIUS,
            ry: TREEMAP_BORDER_RADIUS,
            stroke: function (d) {
              if (d.depth === 0) return getGroupColor(d.id);
              return "transparent";
            },
            strokeWidth: function (d) {
              if (d.depth === 0) return 3;
              return 0;
            }
          })
          .config({
            label: function (d) {
              if (!TREEMAP_SHOW_VALUES) return d.name;
              var value = (d && typeof d.value === "number") ? d.value : (d && d.value != null ? +d.value : 0);
              return d.name + " (" + value + ")";
            }
          });
      }

      if (typeof treemapInstance.width === "function" && width) {
        treemapInstance.width(width);
      }
      if (typeof treemapInstance.height === "function" && height) {
        treemapInstance.height(height);
      }

      return treemapInstance;
    }

    function renderBarChart(width, height) {
      if (!vizContainer) return;

      while (vizContainer.firstChild) {
        vizContainer.removeChild(vizContainer.firstChild);
      }

      if (!Array.isArray(treemapData) || treemapData.length === 0) {
        const empty = document.createElement("div");
        empty.style.display = "flex";
        empty.style.alignItems = "center";
        empty.style.justifyContent = "center";
        empty.style.height = "100%";
        empty.style.fontFamily = "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif";
        empty.style.color = "#666";
        empty.textContent = "No data available";
        vizContainer.appendChild(empty);
        barSvg = null;
        return;
      }

      const isVertical = BAR_ORIENTATION === "vertical";

      const margin = isVertical
        ? {
          top: 16,
          right: Math.max(40, width * 0.06),
          bottom: Math.max(36, height * 0.16),
          left: Math.max(40, width * 0.06)
        }
        : {
          top: 16,
          right: Math.max(40, width * 0.08),
          bottom: 28,
          left: Math.max(80, width * 0.22)
        };

      const innerWidth = Math.max(40, width - margin.left - margin.right);
      const innerHeight = Math.max(40, height - margin.top - margin.bottom);

      const svg = d3.select(vizContainer)
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", "0 0 " + width + " " + height)
        .style("width", "100%")
        .style("height", "100%");

      barSvg = svg;

      const g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var data = treemapData.slice();

      var groupedByName = {};
      data.forEach(function (d) {
        var key = d.name || "";
        if (!key) return;
        if (!groupedByName[key]) {
          groupedByName[key] = {
            name: d.name,
            parent: d.parent,
            value: (typeof d.value === "number" ? d.value : +d.value || 0),
            color: d.color
          };
        }
      });

      data = Object.keys(groupedByName).map(function (k) { return groupedByName[k]; });

      data.sort(function (a, b) {
        var av = typeof a.value === "number" ? a.value : +a.value || 0;
        var bv = typeof b.value === "number" ? b.value : +b.value || 0;
        return d3.descending(av, bv);
      });

      const maxValue = d3.max(data, function (d) {
        return typeof d.value === "number" ? d.value : +d.value || 0;
      }) || 0;

      let x, y;

      if (isVertical) {
        x = d3.scaleBand()
          .domain(data.map(function (d) { return d.name; }))
          .rangeRound([0, innerWidth])
          .padding(0);

        y = d3.scaleLinear()
          .domain([0, maxValue * 1.05 || 1])
          .nice()
          .range([innerHeight, 0]);
      } else {
        y = d3.scaleBand()
          .domain(data.map(function (d) { return d.name; }))
          .rangeRound([0, innerHeight])
          .padding(0);

        x = d3.scaleLinear()
          .domain([0, maxValue * 1.05 || 1])
          .nice()
          .range([0, innerWidth]);
      }

      const bg = g.append("g")
        .attr("fill", "none");

      if (isVertical) {
        bg.selectAll("rect.col-bg")
          .data(data)
          .enter()
          .append("rect")
          .attr("class", "col-bg")
          .attr("x", function (d) { return x(d.name); })
          .attr("y", 0)
          .attr("width", x.bandwidth())
          .attr("height", innerHeight)
          .attr("fill", function (_d, i) { return i % 2 ? "#f5f5f5" : "#ffffff"; })
          .attr("pointer-events", "none");
      } else {
        bg.selectAll("rect.row-bg")
          .data(data)
          .enter()
          .append("rect")
          .attr("class", "row-bg")
          .attr("x", -margin.left)
          .attr("y", function (d) { return y(d.name); })
          .attr("width", innerWidth + margin.left + margin.right)
          .attr("height", y.bandwidth())
          .attr("fill", function (_d, i) { return i % 2 ? "#f5f5f5" : "#ffffff"; })
          .attr("pointer-events", "none");
      }

      const axisFont = Math.max(9, Math.min(13, innerHeight / Math.max(6, data.length) * 0.6));

      if (isVertical) {
        g.append("g")
          .attr("class", "axis axis--y")
          .call(d3.axisLeft(y))
          .selectAll("text")
          .style("font-size", axisFont + "px")
          .style("font-family", "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif");

        g.append("g")
          .attr("class", "axis axis--x")
          .attr("transform", "translate(0," + innerHeight + ")")
          .call(d3.axisBottom(x))
          .selectAll("text")
          .style("font-size", axisFont + "px")
          .style("font-family", "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif");
      } else {
        g.append("g")
          .attr("class", "axis axis--y")
          .call(d3.axisLeft(y))
          .selectAll("text")
          .style("font-size", axisFont + "px")
          .style("font-family", "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif");

        g.append("g")
          .attr("class", "axis axis--x")
          .attr("transform", "translate(0," + innerHeight + ")")
          .call(d3.axisBottom(x).ticks(4))
          .selectAll("text")
          .style("font-size", axisFont + "px")
          .style("font-family", "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif");
      }

      const defs = svg.append("defs");
      const grad = defs.append("linearGradient")
        .attr("id", "barGradient")
        .attr("gradientUnits", "objectBoundingBox");

      if (isVertical) {
        grad.attr("x1", "0%")
          .attr("y1", "100%")
          .attr("x2", "0%")
          .attr("y2", "0%");
      } else {
        grad.attr("x1", "0%")
          .attr("y1", "0%")
          .attr("x2", "100%")
          .attr("y2", "0%");
      }

      grad.append("stop")
        .attr("offset", "0%")
        .attr("stop-color", "#cfe8ff");

      grad.append("stop")
        .attr("offset", "100%")
        .attr("stop-color", "#1f78ff");

      if (!barTooltip) {
        barTooltip = document.createElement("div");
        barTooltip.style.position = "fixed";
        barTooltip.style.pointerEvents = "none";
        barTooltip.style.zIndex = "9999";
        barTooltip.style.background = "white";
        barTooltip.style.borderRadius = "8px";
        barTooltip.style.boxShadow = "0 8px 18px rgba(15,23,42,0.22)";
        barTooltip.style.padding = "8px 10px";
        barTooltip.style.fontSize = "12px";
        barTooltip.style.fontFamily = "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif";
        barTooltip.style.color = "#111827";
        barTooltip.style.opacity = "0";
        barTooltip.style.transition = "opacity 0.12s ease-out, transform 0.12s ease-out";
        barTooltip.style.transform = "translateY(0)";
        document.body.appendChild(barTooltip);
      }

      const barGroup = g.append("g")
        .attr("class", "bars");

      const barThickness = isVertical
        ? Math.max(10, x.bandwidth() * 0.6)
        : Math.max(10, y.bandwidth() * 0.8);

      const bars = barGroup.selectAll("rect.bar")
        .data(data)
        .enter()
        .append("rect")
        .attr("class", "bar")
        .attr("rx", BAR_BORDER_RADIUS)
        .attr("ry", BAR_BORDER_RADIUS)
        .attr("fill", function (d) {
          if (d.color) return d.color;
          if (BAR_COLOR_BY_GROUP) {
            return getGroupColor(d.parent);
          }
          if (PALETTE_MODE === "aiw") return "#2756d3";
          if (PALETTE_MODE === "ceps") return "#207164";
          if (BAR_USE_GRADIENT) {
            return "url(#barGradient)";
          }
          return "#1f78ff";
        })
        .attr("opacity", 0.95);

      if (isVertical) {
        const xOffset = (x.bandwidth() - barThickness) / 2;
        bars
          .attr("x", function (d) { return x(d.name) + xOffset; })
          .attr("width", barThickness)
          .attr("y", innerHeight)
          .attr("height", 0)
          .transition()
          .duration(700)
          .attr("y", function (d) {
            var v = typeof d.value === "number" ? d.value : +d.value || 0;
            return y(v);
          })
          .attr("height", function (d) {
            var v = typeof d.value === "number" ? d.value : +d.value || 0;
            return Math.max(4, innerHeight - y(v));
          });
      } else {
        bars
          .attr("x", 0)
          .attr("y", function (d) { return y(d.name) + (y.bandwidth() - barThickness) / 2; })
          .attr("height", barThickness)
          .attr("width", 0)
          .transition()
          .duration(700)
          .attr("width", function (d) { return x(d.value || 0); });
      }

      const formatValue = d3.format(".1f");
      if (BAR_VALUE_POSITION !== "none") {
        barGroup.selectAll("text.value-label")
          .data(data)
          .enter()
          .append("text")
          .attr("class", "value-label")
          .attr("x", function (d) {
            if (isVertical) {
              return x(d.name) + x.bandwidth() / 2;
            }
            var base = x(d.value || 0);
            if (BAR_VALUE_POSITION === "outside") return base + 6;
            return base - 6;
          })
          .attr("y", function (d) {
            if (isVertical) {
              var v = typeof d.value === "number" ? d.value : +d.value || 0;
              var topY = y(v);
              var barH = Math.max(4, innerHeight - topY);
              if (BAR_VALUE_POSITION === "outside") return topY - 6;
              var maxOffset = 14; // px
              var offset = Math.min(maxOffset, barH / 2);
              return topY + offset;
            }
            return y(d.name) + (y.bandwidth() * 0.8) / 2 + 4;
          })
          .attr("text-anchor", function () {
            if (isVertical) return "middle";
            return BAR_VALUE_POSITION === "outside" ? "start" : "end";
          })
          .attr("fill", BAR_VALUE_POSITION === "inside" ? "#ffffff" : "#111827")
          .style("font-size", Math.max(9, axisFont) + "px")
          .style("font-weight", "600")
          .style("font-family", "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif")
          .text(function (d) {
            var v = typeof d.value === "number" ? d.value : +d.value || 0;
            return formatValue(v);
          });
      }

      bars.on("mousemove", function (event, d) {
        if (!barTooltip) return;
        var name = d.name || "";
        var v = typeof d.value === "number" ? d.value : +d.value || 0;
        barTooltip.innerHTML = "<strong>" + name + "</strong><br/>Value: " + formatValue(v);
        barTooltip.style.left = (event.clientX + 14) + "px";
        barTooltip.style.top = (event.clientY - 24) + "px";
        barTooltip.style.opacity = "1";
        barTooltip.style.transform = "translateY(-2px)";
      });

      bars.on("mouseleave", function () {
        if (!barTooltip) return;
        barTooltip.style.opacity = "0";
        barTooltip.style.transform = "translateY(0)";
      });
    }

    function updateVisualization(width, height) {
      treemapData = normalizeData(originalData).filter(function (d) {
        return activeGroups.has(d.parent);
      });

      if (PLOT_TYPE === "treemap") {
        var instance = ensureTreemapInstance(width, height);
        if (!instance) return;
        instance.data(treemapData).render();
      } else if (PLOT_TYPE === "bar") {
        renderBarChart(width, height);
      }

      updateLegendStyles();
    }

    const renderVisualization = function (currentData, width, height) {
      buildLegend();
      updateVisualization(width, height);
    };

    const renderVisualizationForContainer = function () {
      if (!vizContainer) {
        return
      }
      const rect = vizContainer.getBoundingClientRect();
      const width = rect.width;
      const height = rect.height;
      renderVisualization(null, width, height);
    };

    let resizeTimer;

    window.addEventListener('resize', function () {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(renderVisualizationForContainer, 120);
    });

    if (typeof ResizeObserver !== 'undefined' && vizContainer) {
      const resizeObserver = new ResizeObserver(function () {
        renderVisualizationForContainer();
      });
      resizeObserver.observe(vizContainer);
    }

    // Setup selector buttons
    const selectorButtons = document.querySelectorAll('.selector-button');
    selectorButtons.forEach(function(button) {
      button.addEventListener('click', function() {
        const view = this.getAttribute('data-view');
        if (view === currentView) return;

        currentView = view;

        // Update button states
        selectorButtons.forEach(function(btn) {
          btn.classList.remove('active');
        });
        this.classList.add('active');

        // Update data and re-render
        originalData = getOriginalData();
        renderVisualizationForContainer();
      });
    });

    renderVisualizationForContainer();
  </script>
</body>

</html>