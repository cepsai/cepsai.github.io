<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <style type="text/css">
    .knitr .inline { background-color: #F7F7F7; border: solid 1px #B0B0B0; }
    .error { font-weight: bold; color: #FF0000; }
    .warning { font-weight: bold; }
    .message { font-style: italic; }
    .source, .output, .warning, .error, .message { padding: 0 1em; border: solid 1px #F7F7F7; }
    .source { background-color: #F5F5F5; }
    .rimage .left { text-align: left; }
    .rimage .right { text-align: right; }
    .rimage .center { text-align: center; }

    body {
      margin: 0;
      overflow: hidden;
      height: 100vh;
      font-family: Arial, sans-serif;
      background-color: white;
    }

    .viz-grid {
      display: grid;
      grid-template-rows: 16fr 1fr 2fr 1fr;
      grid-template-columns: 1fr 1fr;
      height: 100vh;
      width: 100vw;
      box-sizing: border-box;
      padding-bottom: clamp(8px, 2vh, 18px);
    }

    #container1 {
      grid-row: 1;
      grid-column: 1 / span 2;
      overflow: hidden;
      min-height: 0;
    }

    #container5 {
      grid-row: 2;
      grid-column: 1 / span 2;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 20px;
      overflow: hidden;
    }

    #container2 {
      grid-row: 3;
      grid-column: 1 / span 2;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #container3 {
      grid-row: 4;
      grid-column: 1;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0 20px;
      overflow: hidden;
      min-width: 0;
    }

    #container4 {
      grid-row: 4;
      grid-column: 2;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 20px;
      overflow: hidden;
      min-width: 0;
    }

    #container4 a {
      height: 100%;
      display: flex;
      align-items: center;
    }

    #viz {
      width: 100%;
      height: 100%;
      min-height: 0;
      min-width: 0;
    }

    .custom-legend {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      gap: clamp(4px, 1vw, 10px);
      padding: clamp(2px, 0.5vh, 4px) clamp(4px, 0.8vw, 8px);
      overflow: auto;
      max-width: 100%;
      max-height: 100%;
      font-size: clamp(8px, 1.3vw, 13px);
      font-weight: 600;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: opacity 0.2s ease;
      font-weight: 600;
      color: #333;
      position: relative;
    }

    .legend-item.inactive { opacity: 0.35; }

    .legend-square {
      width: clamp(10px, 1.2vw, 14px);
      height: clamp(10px, 1.2vw, 14px);
      border-radius: 4px;
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.15) inset;
    }

    .legend-item:focus-visible {
      outline: 2px solid rgba(0, 0, 0, 0.5);
      outline-offset: 2px;
    }

    .logo {
      height: 100%;
      width: auto;
      max-height: 100%;
      max-width: 100%;
      pointer-events: auto;
      object-fit: contain;
    }

    .source-text {
      font-size: clamp(10px, 1.6vw, 16px);
      font-weight: 600;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      font-style: normal;
    }

    .source-text a {
      color: #2756d3;
      text-decoration: underline;
      cursor: pointer;
      font-style: normal;
    }

    .source-text a:visited { color: #2756d3; }

    .footnote-text {
      font-size: clamp(10px, 1.6vw, 16px);
      font-style: italic;
      color: #333;
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    @media (max-height: 500px) {
      .viz-grid { grid-template-rows: 1fr; grid-template-columns: 1fr; }
      #container1 { grid-row: 1; grid-column: 1; }
      #container2, #container3, #container4, #container5 { display: none !important; }
      .custom-legend, .source-text, .logo, .footnote-text { display: none !important; }
    }
  </style>

  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3plus-hierarchy@1"></script>
</head>

<body>
  <div class="viz-grid">
    <div id="container1" class="container viz-container">
      <div id="viz"></div>
    </div>
    <div id="container5" class="container footnote-container">
      <div class="footnote-text" id="footnote-text">
        This is a footnote example
      </div>
    </div>
    <div id="container2" class="container legend-container">
      <div class="custom-legend" id="legend"></div>
    </div>
    <div id="container3" class="container source-container">
      <div class="source-text" id="source-text">
        Source: <a href="https://huggingface.co/spaces/AIEnergyScore/Leaderboard" target="_blank"
          rel="noopener noreferrer">AI Energy Score Leaderboard</a>
      </div>
    </div>
    <div id="container4" class="container logo-container">
      <a href="https://aiworld.eu/" id="logo-link" target="_blank" rel="noopener">
        <img src="https://aiworld.eu/logo-transparent.svg" class="logo" alt="AI World logo" />
      </a>
    </div>
  </div>

  <script>
    const SHOW_CONTAINER_2 = 0;
    const SHOW_CONTAINER_3 = 1;
    const SHOW_CONTAINER_4 = 1;
    const SHOW_CONTAINER_5 = 0;

    const VIZ_CONTAINER_ID = 'viz';
    const SOURCE_CONTAINER_ID = 'source-text';
    const LOGO_CONTAINER_ID = 'logo-link';
    const FOOTNOTE_CONTAINER_ID = 'footnote-text';

    const vizContainer = document.getElementById(VIZ_CONTAINER_ID);

    (function applyContainerVisibility() {
      const vizGrid = document.querySelector('.viz-grid');
      const container1 = document.getElementById('container1');
      const container2 = document.getElementById('container2');
      const container3 = document.getElementById('container3');
      const container4 = document.getElementById('container4');
      const container5 = document.getElementById('container5');

      if (!SHOW_CONTAINER_2) container2.style.display = 'none';
      if (!SHOW_CONTAINER_3) container3.style.display = 'none';
      if (!SHOW_CONTAINER_4) container4.style.display = 'none';
      if (!SHOW_CONTAINER_5) container5.style.display = 'none';

      const row2Visible = SHOW_CONTAINER_5;
      const row3Visible = SHOW_CONTAINER_2;
      const row4Visible = SHOW_CONTAINER_3 || SHOW_CONTAINER_4;

      let gridRows = [];
      let currentRow = 1;

      const container1Height = 20 - (row2Visible ? 1 : 0) - (row3Visible ? 2 : 0) - (row4Visible ? 1 : 0);
      gridRows.push(`${container1Height}fr`);

      if (row2Visible) { gridRows.push('1fr'); currentRow++; container5.style.gridRow = currentRow.toString(); }
      if (row3Visible) { gridRows.push('2fr'); currentRow++; container2.style.gridRow = currentRow.toString(); }
      if (row4Visible) {
        gridRows.push('1fr');
        currentRow++;
        if (SHOW_CONTAINER_3) container3.style.gridRow = currentRow.toString();
        if (SHOW_CONTAINER_4) container4.style.gridRow = currentRow.toString();
      }

      vizGrid.style.gridTemplateRows = gridRows.join(' ');
      container1.style.gridRow = '1';

      if (row4Visible) {
        if (SHOW_CONTAINER_3 && !SHOW_CONTAINER_4) container3.style.gridColumn = '1 / span 2';
        else if (!SHOW_CONTAINER_3 && SHOW_CONTAINER_4) container4.style.gridColumn = '1 / span 2';
      }
    })();

    const PLOT_TYPE = "bar";

    // === DATA (your extremes table) ===
    // IMPORTANT: add `class` for text_generation + reasoning (A/B/C). Others can stay null.
    const rawRows = [
      { model: "google/pix2struct-base", total_gpu_energy: 0.04574709, extreme: "lowest", source_csv: "image_captioning", class: null, name: "Image Captioning" },
      { model: "Salesforce/blip2-flan-t5-xxl", total_gpu_energy: 0.179930966, extreme: "highest", source_csv: "image_captioning", class: null, name: "Image Captioning" },

      { model: "facebook/wav2vec2-base-960h", total_gpu_energy: 0.000619699, extreme: "lowest", source_csv: "asr", class: null, name: "Speech Recognition" },
      { model: "openai/whisper-large-v3", total_gpu_energy: 0.086679066, extreme: "highest", source_csv: "asr", class: null, name: "Speech Recognition" },

      { model: "Mitsua/mitsua-diffusion-one", total_gpu_energy: 0.186811914, extreme: "lowest", source_csv: "image_generation", class: null, name: "Image Generation" },
      { model: "stabilityai/stable-diffusion-xl-base-1.0", total_gpu_energy: 1.639845472, extreme: "highest", source_csv: "image_generation", class: null, name: "Image Generation" },

      { model: "avsolatorio/GIST-all-MiniLM-L6-v2", total_gpu_energy: 0.000106329, extreme: "lowest", source_csv: "sentence_similarity", class: null, name: "Sentence Similarity" },
      { model: "Salesforce/SFR-Embedding-Mistral", total_gpu_energy: 0.005220944, extreme: "highest", source_csv: "sentence_similarity", class: null, name: "Sentence Similarity" },

      { model: "lvwerra/distilbert-imdb", total_gpu_energy: 0.000216022, extreme: "lowest", source_csv: "text_classification", class: null, name: "Text Classification" },
      { model: "google-t5/t5-11b", total_gpu_energy: 0.027787079, extreme: "highest", source_csv: "text_classification", class: null, name: "Text Classification" },

      { model: "microsoft/resnet-18", total_gpu_energy: 0.000299115, extreme: "lowest", source_csv: "image_classification", class: null, name: "Image Classification" },
      { model: "deepmind/vision-perceiver-conv", total_gpu_energy: 0.002641366, extreme: "highest", source_csv: "image_classification", class: null, name: "Image Classification" },

      { model: "KipperDev/bart_summarizer_model", total_gpu_energy: 0.000784852, extreme: "lowest", source_csv: "summarization", class: null, name: "Summarization" },
      { model: "google-t5/t5-11b", total_gpu_energy: 0.034807171, extreme: "highest", source_csv: "summarization", class: null, name: "Summarization" },

      { model: "hustvl/yolos-tiny", total_gpu_energy: 0.001004166, extreme: "lowest", source_csv: "object_detection", class: null, name: "Object Detection" },
      { model: "hustvl/yolos-base", total_gpu_energy: 0.007980927, extreme: "highest", source_csv: "object_detection", class: null, name: "Object Detection" },

      { model: "mrm8488/bert-tiny-finetuned-squadv2", total_gpu_energy: 0.0000554, extreme: "lowest", source_csv: "question_answering", class: null, name: "Question Answering" },
      { model: "google-t5/t5-11b", total_gpu_energy: 0.178130109, extreme: "highest", source_csv: "question_answering", class: null, name: "Question Answering" },

      // text_generation (A/B/C)
      { model: "distilbert/distilgpt2", total_gpu_energy: 0.001313, extreme: "lowest", source_csv: "text_generation", class: "A", name: "Text Generation A" },
      { model: "ibm-granite/granite-4.0-h-tiny", total_gpu_energy: 0.08182, extreme: "highest", source_csv: "text_generation", class: "A", name: "Text Generation A" },

      { model: "Qwen/Qwen3-30B-A3B", total_gpu_energy: 0.03738, extreme: "lowest", source_csv: "text_generation", class: "B", name: "Text Generation B" },
      { model: "mistralai/Mixtral-8x7B-v0.1", total_gpu_energy: 0.61539, extreme: "highest", source_csv: "text_generation", class: "B", name: "Text Generation B" },

      { model: "deepseek-ai/DeepSeek-R1-Distill-Qwen-32B", total_gpu_energy: 0.03664, extreme: "lowest", source_csv: "text_generation", class: "C", name: "Text Generation C" },
      { model: "CohereForAI/c4ai-command-r-plus", total_gpu_energy: 3.426382, extreme: "highest", source_csv: "text_generation", class: "C", name: "Text Generation C" },

      // reasoning (A/B/C)
      { model: "Qwen/Qwen3-0.6B", total_gpu_energy: 0.54699, extreme: "lowest", source_csv: "reasoning", class: "A", name: "Reasoning A" },
      { model: "HuggingFaceTB/SmolLM3-3B", total_gpu_energy: 12.79122, extreme: "highest", source_csv: "reasoning", class: "A", name: "Reasoning A" },

      { model: "openai/gpt-oss-20b low", total_gpu_energy: 1.13559, extreme: "lowest", source_csv: "reasoning", class: "B", name: "Reasoning B" },
      { model: "LGAI-EXAONE/EXAONE-4.0-32B", total_gpu_energy: 18.99236, extreme: "highest", source_csv: "reasoning", class: "B", name: "Reasoning B" },

      { model: "Qwen/Qwen3-Next-80B-A3B-Instruct", total_gpu_energy: 0.26673, extreme: "lowest", source_csv: "reasoning", class: "C", name: "Reasoning C" },
      { model: "openai/gpt-oss-120b high", total_gpu_energy: 8.50362, extreme: "highest", source_csv: "reasoning", class: "C", name: "Reasoning C" },
    ];

    // --- split text_generation + reasoning into A/B/C subcategories (from `class`) ---
    const SPLIT_CATS = new Set(["text_generation", "reasoning"]);
    const VALID_CLASSES = new Set(["A", "B", "C"]);

    // Process rawRows to create originalData format
    function processRawRows(rows) {
      const categories = {};

      rows.forEach(function(row) {
        const cat = row.source_csv;
        const energy = row.total_gpu_energy;
        const extreme = row.extreme;
        const displayName = row.name;

        // For text_generation and reasoning with classes, create separate entries
        if (SPLIT_CATS.has(cat) && row.class && VALID_CLASSES.has(row.class)) {
          const key = cat + "_" + row.class;
          if (!categories[key]) {
            categories[key] = { name: displayName, low: null, high: null };
          }
          if (extreme === "lowest") categories[key].low = energy;
          if (extreme === "highest") categories[key].high = energy;
        } else {
          // For other categories, aggregate all entries
          if (!categories[cat]) {
            categories[cat] = { name: displayName, low: null, high: null };
          }
          if (extreme === "lowest") {
            categories[cat].low = (categories[cat].low === null) ? energy : Math.min(categories[cat].low, energy);
          }
          if (extreme === "highest") {
            categories[cat].high = (categories[cat].high === null) ? energy : Math.max(categories[cat].high, energy);
          }
        }
      });

      return Object.keys(categories).map(function(key) {
        const cat = categories[key];
        return {
          id: cat.name,
          name: cat.name,
          value: cat.low !== null ? cat.low : 0,
          high: cat.high !== null ? cat.high : cat.low
        };
      });
    }

    const originalData = processRawRows(rawRows);

    // === SETTINGS ===
    const BAR_BORDER_RADIUS = 0;
    const BAR_USE_GRADIENT = 0;
    const BAR_VALUE_POSITION = "outside";
    const BAR_ORIENTATION = "horizontal";
    const PALETTE_MODE = "aiw";
    const HIGH_BAR_COLOR = "#ff7f0e"; // the "extra" stacked segment color

    function normalizeData(arr) {
      return arr.map(function (d) {
        var parent = d.parent || d.group || d.domain || d.category || d.type || d.class || "All";
        var name = d.name || d.id || d.label || d.title;
        var value = (d.value != null) ? +d.value : (d.count != null) ? +d.count : (d.size != null) ? +d.size : 0;
        var high = (d.high != null) ? +d.high : null;
        var color = d.color != null ? d.color : null;
        return { parent: parent, name: name, value: value, high: high, color: color };
      });
    }

    let treemapData = normalizeData(originalData);

    function makeStackedRows(baseRows) {
      // returns [{name,parent,low,delta,high,bump,color}]
      return baseRows.map(function (d) {
        var low = (typeof d.value === "number" ? d.value : +d.value || 0);
        var high = (d.high != null) ? +d.high : low;
        var delta = Math.max(0, high - low);
        var bump = low > 0 ? (high - low) / low : 0;
        return { name: d.name, parent: d.parent, low: low, delta: delta, high: high, bump: bump, color: d.color };
      });
    }

    let barTooltip = null;
    let barRevealTimeout = null;

    function renderBarChart(width, height) {
      if (!vizContainer) return;

      if (barRevealTimeout) {
        clearTimeout(barRevealTimeout);
        barRevealTimeout = null;
      }

      while (vizContainer.firstChild) vizContainer.removeChild(vizContainer.firstChild);

      if (!Array.isArray(treemapData) || treemapData.length === 0) {
        const empty = document.createElement("div");
        empty.style.display = "flex";
        empty.style.alignItems = "center";
        empty.style.justifyContent = "center";
        empty.style.height = "100%";
        empty.style.fontFamily = "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif";
        empty.style.color = "#666";
        empty.textContent = "No data available";
        vizContainer.appendChild(empty);
        return;
      }

      // Force horizontal
      const margin = { top: 16, right: Math.max(70, width * 0.11), bottom: 34, left: Math.max(140, width * 0.18) };
      const innerWidth = Math.max(40, width - margin.left - margin.right);
      const innerHeight = Math.max(40, height - margin.top - margin.bottom);

      const svg = d3.select(vizContainer)
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", "0 0 " + width + " " + height)
        .style("width", "100%")
        .style("height", "100%");

      const g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // Unique by name
      const byName = {};
      treemapData.forEach(function (d) {
        var key = d.name || "";
        if (!key) return;
        if (!byName[key]) byName[key] = { name: d.name, parent: d.parent, value: (typeof d.value === "number" ? d.value : +d.value || 0), high: d.high, color: d.color };
      });
      const base = Object.keys(byName).map(function (k) { return byName[k]; });

      // Build stacked rows: [low + delta] = high
      const rows = makeStackedRows(base);

      // Sort SMALLEST first (by total/high)
      const nameOrderAsc = rows.slice().sort(function (a, b) {
        return d3.ascending(a.high, b.high);
      }).map(function (d) { return d.name; });

      const rowByName = {};
      rows.forEach(function (r) { rowByName[r.name] = r; });

      const x = d3.scaleLinear().domain([0, 1]).nice().range([0, innerWidth]);
      const y = d3.scaleBand().domain([]).rangeRound([0, innerHeight]).paddingInner(0.18).paddingOuter(0.22);

      const backgroundGroup = g.append("g").attr("class", "bar-backgrounds").attr("fill", "none");
      const yAxisGroup = g.append("g").attr("class", "axis axis--y");
      const xAxisGroup = g.append("g").attr("class", "axis axis--x").attr("transform", "translate(0," + innerHeight + ")");

      const xAxisLabelPadding = 22;
      const xAxisLabel = g.append("text")
        .attr("class", "axis-label")
        .attr("x", innerWidth / 2)
        .attr("y", innerHeight + xAxisLabelPadding)
        .attr("text-anchor", "middle")
        .style("font-weight", "600")
        .style("font-family", "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif")
        .style("fill", "#111827")
        .text("kWh per 1k Queries");

      const defs = svg.append("defs");

      const gradLow = defs.append("linearGradient")
        .attr("id", "barGradientLow")
        .attr("gradientUnits", "objectBoundingBox")
        .attr("x1", "0%").attr("y1", "0%").attr("x2", "100%").attr("y2", "0%");
      gradLow.append("stop").attr("offset", "0%").attr("stop-color", "#cfe8ff");
      gradLow.append("stop").attr("offset", "100%").attr("stop-color", "#1f78ff");

      const gradDelta = defs.append("linearGradient")
        .attr("id", "barGradientDelta")
        .attr("gradientUnits", "objectBoundingBox")
        .attr("x1", "0%").attr("y1", "0%").attr("x2", "100%").attr("y2", "0%");
      gradDelta.append("stop").attr("offset", "0%").attr("stop-color", "#ffe2c2");
      gradDelta.append("stop").attr("offset", "100%").attr("stop-color", HIGH_BAR_COLOR);

      if (!barTooltip) {
        barTooltip = document.createElement("div");
        barTooltip.style.position = "fixed";
        barTooltip.style.pointerEvents = "none";
        barTooltip.style.zIndex = "9999";
        barTooltip.style.background = "white";
        barTooltip.style.borderRadius = "8px";
        barTooltip.style.boxShadow = "0 8px 18px rgba(15,23,42,0.22)";
        barTooltip.style.padding = "8px 10px";
        barTooltip.style.fontSize = "12px";
        barTooltip.style.fontFamily = "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif";
        barTooltip.style.color = "#111827";
        barTooltip.style.opacity = "0";
        barTooltip.style.transition = "opacity 0.12s ease-out, transform 0.12s ease-out";
        barTooltip.style.transform = "translateY(0)";
        document.body.appendChild(barTooltip);
      }

      const barGroup = g.append("g").attr("class", "bars");
      const valueLabelGroup = g.append("g").attr("class", "value-labels");
      const formatValue = d3.format(".3f");
      const axisFontFamily = "system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif";

      function showTooltip(event, name) {
        const r = rowByName[name];
        if (!r) return;
        barTooltip.innerHTML =
          "<strong>" + name + "</strong>" +
          "<br/>Lowest: " + formatValue(r.low) + " kWh" +
          "<br/>Highest: " + formatValue(r.high) + " kWh" +
          "<br/>Range: " + formatValue(r.delta) + " kWh (" + Math.round(r.bump * 100) + "%)";
        barTooltip.style.left = (event.clientX + 14) + "px";
        barTooltip.style.top = (event.clientY - 24) + "px";
        barTooltip.style.opacity = "1";
        barTooltip.style.transform = "translateY(-2px)";
      }
      function hideTooltip() {
        barTooltip.style.opacity = "0";
        barTooltip.style.transform = "translateY(0)";
      }

      const getAnimationDuration = function (name) {
        const durationBase = 350;
        const durationRange = 450;
        const r = rowByName[name];
        if (!r) return durationBase;
        const widthPx = Math.max(0, x(r.high));
        const ratio = Math.min(1, Math.max(0, innerWidth ? widthPx / innerWidth : 0));
        let duration = durationBase + ratio * durationRange;
        if (finalBarName && name === finalBarName) {
          return duration * 5;
        }
        if (penultimateBarName && name === penultimateBarName) {
          return duration * 1.8;
        }
        return duration;
      };

      const renderFrame = function (visibleNames) {
        const visibleRows = visibleNames.map(function (n) { return rowByName[n]; }).filter(Boolean);

        const maxHigh = d3.max(visibleRows, function (d) { return d.high; }) || 0;
        x.domain([0, maxHigh * 1.05 || 1]).nice();

        y.domain(visibleNames);

        const axisFont = Math.max(9, Math.min(13, innerHeight / Math.max(6, visibleNames.length) * 0.6));

        // Axes
        yAxisGroup.transition()
          .duration(450)
          .call(d3.axisLeft(y))
          .selectAll("text")
          .style("font-size", axisFont + "px")
          .style("font-family", axisFontFamily);

        xAxisGroup.transition()
          .duration(450)
          .call(d3.axisBottom(x).ticks(4))
          .selectAll("text")
          .style("font-size", axisFont + "px")
          .style("font-family", axisFontFamily);

        xAxisLabel.style("font-size", (axisFont + 2) + "px");

        // Row backgrounds
        const rowBackgrounds = backgroundGroup.selectAll("rect.row-bg")
          .data(visibleNames, function (d) { return d; });

        rowBackgrounds.exit()
          .transition().duration(350)
          .attr("height", 0).attr("opacity", 0)
          .remove();

        const rowEnter = rowBackgrounds.enter()
          .append("rect")
          .attr("class", "row-bg")
          .attr("x", -margin.left)
          .attr("y", innerHeight / 2)
          .attr("width", innerWidth + margin.left + margin.right)
          .attr("height", 0)
          .attr("fill", "#ffffff")
          .attr("pointer-events", "none");

        rowEnter.merge(rowBackgrounds)
          .transition().duration(450)
          .attr("y", function (name) { return y(name); })
          .attr("height", y.bandwidth())
          .attr("fill", function (_name, i) { return i % 2 ? "#f5f5f5" : "#ffffff"; });

        const barThickness = Math.max(10, y.bandwidth() * 0.78);
        const yOffset = (y.bandwidth() - barThickness) / 2;

        // ---- STACKED LOW SEGMENT ----
        const lowBars = barGroup.selectAll("rect.bar-low")
          .data(visibleRows, function (d) { return d.name; });

        lowBars.exit()
          .transition().duration(350)
          .attr("width", 0).style("opacity", 0)
          .remove();

        const lowEnter = lowBars.enter()
          .append("rect")
          .attr("class", "bar-low")
          .attr("rx", BAR_BORDER_RADIUS)
          .attr("ry", BAR_BORDER_RADIUS)
          .attr("fill", BAR_USE_GRADIENT ? "url(#barGradientLow)" : HIGH_BAR_COLOR)
          .attr("opacity", 0.95)
          .attr("x", 0)
          .attr("y", function (d) { return y(d.name) + yOffset; })
          .attr("height", barThickness)
          .attr("width", 0);

        lowEnter.merge(lowBars)
          .on("mousemove", function (event, d) { showTooltip(event, d.name); })
          .on("mouseleave", hideTooltip)
          .transition().duration(function (d) { return getAnimationDuration(d.name); })
          .attr("y", function (d) { return y(d.name) + yOffset; })
          .attr("height", barThickness)
          .attr("width", function (d) { return x(d.low); });

        // ---- STACKED DELTA SEGMENT (ON TOP OF LOW) ----
        const deltaBars = barGroup.selectAll("rect.bar-delta")
          .data(visibleRows, function (d) { return d.name; });

        deltaBars.exit()
          .transition().duration(350)
          .attr("width", 0).style("opacity", 0)
          .remove();

        const deltaEnter = deltaBars.enter()
          .append("rect")
          .attr("class", "bar-delta")
          .attr("rx", BAR_BORDER_RADIUS)
          .attr("ry", BAR_BORDER_RADIUS)
          .attr("fill", BAR_USE_GRADIENT ? "url(#barGradientDelta)" : "#1f78ff")
          .attr("opacity", 0.95)
          .attr("x", 0)
          .attr("y", function (d) { return y(d.name) + yOffset; })
          .attr("height", barThickness)
          .attr("width", 0);

        deltaEnter.merge(deltaBars)
          .on("mousemove", function (event, d) { showTooltip(event, d.name); })
          .on("mouseleave", hideTooltip)
          .transition().duration(function (d) { return getAnimationDuration(d.name); })
          .attr("y", function (d) { return y(d.name) + yOffset; })
          .attr("height", barThickness)
          .attr("x", function (d) { return x(d.low); })
          .attr("width", function (d) { return Math.max(0, x(d.high) - x(d.low)); });

        // Value labels (show total/high at end)
        if (BAR_VALUE_POSITION === "none") {
          valueLabelGroup.selectAll("text.value-label").remove();
        } else {
          const labels = valueLabelGroup.selectAll("text.value-label")
            .data(visibleRows, function (d) { return d.name; });

          labels.exit().transition().duration(250).style("opacity", 0).remove();

          const labelsEnter = labels.enter()
            .append("text")
            .attr("class", "value-label")
            .attr("x", 0)
            .attr("y", innerHeight / 2)
            .attr("fill", "#111827")
            .attr("text-anchor", "start")
            .style("font-weight", "600")
            .style("font-family", axisFontFamily)
            .style("opacity", 0);

          labelsEnter.merge(labels)
            .style("font-size", Math.max(9, axisFont) + "px")
            .text(function (d) { return formatValue(d.high); })
            .transition()
            .delay(function (d) {
              if (finalBarName && d.name === finalBarName) {
                return getAnimationDuration(d.name);
              }
              return 0;
            })
            .duration(function (d) {
              if (finalBarName && d.name === finalBarName) {
                return 800;
              }
              return 600;
            })
            .attr("x", function (d) { return x(d.high) + 6; })
            .attr("y", function (d) { return y(d.name) + yOffset + barThickness / 2 + 4; })
            .style("opacity", 1);
        }
      };

      // Identify final and penultimate bars for custom animation speeds
      const finalBarName = nameOrderAsc.length ? nameOrderAsc[nameOrderAsc.length - 1] : null;
      const penultimateBarName = nameOrderAsc.length > 1 ? nameOrderAsc[nameOrderAsc.length - 2] : null;

      // Reveal: SMALLEST FIRST, and as we add bigger ones, we add them "on top"
      // (prepend so the newest/bigger appears above the existing ones)
      const visibleNames = [];
      let i = 0;
      const revealDelay = 1500;

      const revealNext = function () {
        barRevealTimeout = null;
        if (i >= nameOrderAsc.length) return;

        // add bigger ones on top while revealing smallest->largest:
        visibleNames.unshift(nameOrderAsc[i]);

        i += 1;
        renderFrame(visibleNames);

        if (i < nameOrderAsc.length) {
          barRevealTimeout = setTimeout(revealNext, revealDelay);
        }
      };

      revealNext();
    }

    function updateVisualization(width, height) {
      treemapData = normalizeData(originalData); // (legend filtering removed here since SHOW_CONTAINER_2=0)
      if (PLOT_TYPE === "bar") renderBarChart(width, height);
    }

    const renderVisualizationForContainer = function () {
      if (!vizContainer) return;
      const rect = vizContainer.getBoundingClientRect();
      updateVisualization(rect.width, rect.height);
    };

    let resizeTimer;
    window.addEventListener('resize', function () {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(renderVisualizationForContainer, 120);
    });

    if (typeof ResizeObserver !== 'undefined' && vizContainer) {
      const resizeObserver = new ResizeObserver(function () {
        renderVisualizationForContainer();
      });
      resizeObserver.observe(vizContainer);
    }

    renderVisualizationForContainer();
  </script>
</body>

</html>