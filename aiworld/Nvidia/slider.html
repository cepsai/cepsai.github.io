<div id="sliderPanel" class="range-slider-panel">
  <div class="range-slider-row">
    <div class="range-slider-info range-slider-info-start">
      <span data-role="title-start" class="range-slider-title">Starting Week</span>
      <span data-label="start" class="range-slider-value">Week 0</span>
    </div>
    <div class="range-slider-track-wrapper">
      <div class="range-slider-track">
        <div class="range-slider-selection" data-role="selection"></div>
      </div>
      <input type="range" min="0" max="0" step="1" value="0" data-role="start" aria-label="Starting period">
      <input type="range" min="0" max="0" step="1" value="0" data-role="end" aria-label="Ending period">
    </div>
    <div class="range-slider-info range-slider-info-end">
      <span data-role="title-end" class="range-slider-title">Ending Week</span>
      <span data-label="end" class="range-slider-value">Week 0</span>
    </div>
  </div>
  <div class="range-slider-controls">
    <div class="range-slider-controls-left">
      <button type="button" class="rs-btn" data-action="play">Play</button>
      <button type="button" class="rs-btn hidden" data-action="pause">Pause</button>
      <button type="button" class="rs-btn" data-action="reset">Reset</button>
    </div>
    <div class="range-slider-controls-right">
      <label class="rs-label">Speed
        <select class="rs-select" data-role="speed">
          <option value="900">Slow</option>
          <option value="500" selected>Normal</option>
          <option value="250">Fast</option>
          <option value="120">Very fast</option>
        </select>
      </label>
      <label class="rs-label">Mode
        <select class="rs-select" data-role="mode">
          <option value="grow" selected>Grow end</option>
          <option value="slide">Slide window</option>
        </select>
      </label>
      <label class="rs-label">Step
        <select class="rs-select" data-role="step">
          <option value="1" selected>1</option>
          <option value="2">2</option>
          <option value="4">4</option>
        </select>
      </label>
    </div>
  </div>
</div>
<style>
.range-slider-panel {
  width: 80%;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: center;
  gap: 10px;
  padding: 6px 16px;
  background: var(--viz-panel-surface, rgba(255, 255, 255, 0.7));
  border-radius: 10px;
  box-shadow: 0 1px 4px var(--viz-elevation-shadow, rgba(0, 0, 0, 0.18));
  font-size: clamp(6px, 1.5vw, 12px);
  color: var(--viz-control-text, #1f2a44);
}

.range-slider-panel.is-disabled { opacity: 0.6; }

.range-slider-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: clamp(10px, 2vw, 24px);
  width: 100%;
}

.range-slider-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: clamp(80px, 14vw, 140px);
}

.range-slider-info-start { align-items: flex-start; }
.range-slider-info-end { align-items: flex-end; text-align: right; }

.range-slider-title { font-weight: 600; color: var(--viz-subtitle-color, #26344f); }
.range-slider-value { font-weight: 600; color: var(--viz-muted-text, #7a8094); }

.range-slider-track-wrapper {
  position: relative;
  flex: 1 1 auto;
  min-width: clamp(120px, 100%, 600px);
  height: 32px;
  display: flex;
  align-items: center;
}

.range-slider-track {
  position: absolute;
  left: 0;
  right: 0;
  top: 68%;
  height: clamp(4px, 1.2vw, 8px);
  background: var(--viz-track-bg, #e2e5f1);
  border-radius: 999px;
  transform: translateY(-50%);
  pointer-events: none;
}

.range-slider-selection {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 100%;
  background: var(--viz-selection-color, #2756d3);
  border-radius: 999px;
}

.range-slider-track-wrapper input[type="range"] {
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  width: 100%;
  height: 100%;
  margin: 0;
  background: none;
  pointer-events: none;
  appearance: none;
  -webkit-appearance: none;
}

.range-slider-track-wrapper input[data-role="start"] { z-index: 2; }
.range-slider-track-wrapper input[data-role="end"] { z-index: 3; }

.range-slider-track-wrapper input[type="range"]::-webkit-slider-runnable-track { height: 6px; background: transparent; }
.range-slider-track-wrapper input[type="range"]::-webkit-slider-thumb {
  pointer-events: all;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--viz-control-bg, #ffffff);
  border: 2px solid var(--viz-selection-color, #2756d3);
  box-shadow: 0 1px 4px var(--viz-elevation-shadow, rgba(0, 0, 0, 0.15));
  -webkit-appearance: none;
  appearance: none;
}

.range-slider-track-wrapper input[type="range"]::-moz-range-track { height: 6px; background: transparent; }
.range-slider-track-wrapper input[type="range"]::-moz-range-thumb {
  pointer-events: all;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--viz-control-bg, #ffffff);
  border: 2px solid var(--viz-selection-color, #2756d3);
  box-shadow: 0 1px 4px var(--viz-elevation-shadow, rgba(0, 0, 0, 0.15));
}

.range-slider-track-wrapper input[type="range"]:disabled::-webkit-slider-thumb,
.range-slider-track-wrapper input[type="range"]:disabled::-moz-range-thumb {
  border-color: var(--viz-disabled-border, #aeb4c4);
  background: var(--viz-disabled-fill, #f0f1f5);
}

.range-slider-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  width: 100%;
}

.range-slider-controls-left { display: flex; gap: 8px; align-items: center; }
.range-slider-controls-right { display: flex; gap: 10px; align-items: center; }

.rs-btn {
  border: 1px solid var(--viz-border-color, #cfd2d7);
  background: var(--viz-control-bg, #fff);
  padding: 6px 12px;
  border-radius: 8px;
  font-weight: 600;
  color: var(--viz-control-text, #1f2a44);
  cursor: pointer;
  transition: transform .08s ease, background .12s ease, border-color .12s ease;
}

.rs-btn:hover { transform: translateY(-1px); }
.rs-btn:active { transform: translateY(0); }
.rs-btn.hidden { display: none; }

.rs-label { display: inline-flex; align-items: center; gap: 6px; font-weight: 600; color: var(--viz-subtitle-color, #333); }
.rs-select {
  border: 1px solid var(--viz-border-color, #cfd2d7);
  border-radius: 8px;
  padding: 6px 10px;
  font-weight: 600;
  background: var(--viz-control-bg, #fff);
  color: var(--viz-control-text, #1f2a44);
}

@media (max-width: 640px) {
  .range-slider-controls { flex-direction: column; align-items: stretch; }
  .range-slider-controls-right { justify-content: space-between; width: 100%; }
}
</style>
<script>
(function(){
  const clamp=(value,min,max)=>Math.min(Math.max(value,min),max);
  const RangeSlider={
    init(config){
      if(!config||!config.containerEl){ return; }
      this.root=config.containerEl.querySelector(".range-slider-panel")||config.containerEl;
      this.startInput=this.root.querySelector('[data-role="start"]');
      this.endInput=this.root.querySelector('[data-role="end"]');
      this.selectionEl=this.root.querySelector('[data-role="selection"]');
      this.startTitle=this.root.querySelector('[data-role="title-start"]');
      this.endTitle=this.root.querySelector('[data-role="title-end"]');
      this.startValue=this.root.querySelector('[data-label="start"]');
      this.endValue=this.root.querySelector('[data-label="end"]');
      this.playBtn=this.root.querySelector('[data-action="play"]');
      this.pauseBtn=this.root.querySelector('[data-action="pause"]');
      this.resetBtn=this.root.querySelector('[data-action="reset"]');
      this.speedSelect=this.root.querySelector('[data-role="speed"]');
      this.modeSelect=this.root.querySelector('[data-role="mode"]');
      this.stepSelect=this.root.querySelector('[data-role="step"]');
      this.onChange=typeof config.onChange==="function"?config.onChange:function(){};
      this.getLabel=function(index){ return String(index); };
      this.unitLabel="Period";
      this.state={min:0,max:0,start:0,end:0};
      this.playTimer=null;
      this.playSpeed=this.readSpeed();
      this.playMode=this.readMode();
      this.playStep=this.readStep();
      const handleInput=role=>{
        if(!this.startInput||!this.endInput){ return; }
        const input=role==="start"?this.startInput:this.endInput;
        let value=Math.round(Number(input.value));
        if(!Number.isFinite(value)){ value=role==="start"?this.state.start:this.state.end; }
        value=clamp(value,this.state.min,this.state.max);
        if(role==="start"){
          this.state.start=value;
          if(value>this.state.end){
            this.state.end=value;
            this.endInput.value=String(value);
          }
        }else{
          this.state.end=value;
          if(value<this.state.start){
            this.state.start=value;
            this.startInput.value=String(value);
          }
        }
        this.updateDerived(true);
      };
      if(this.startInput){
        this.startInput.addEventListener("input",()=>handleInput("start"));
        this.startInput.addEventListener("change",()=>handleInput("start"));
      }
      if(this.endInput){
        this.endInput.addEventListener("input",()=>handleInput("end"));
        this.endInput.addEventListener("change",()=>handleInput("end"));
      }
      if(this.playBtn){ this.playBtn.addEventListener("click",()=>this.play()); }
      if(this.pauseBtn){ this.pauseBtn.addEventListener("click",()=>this.pause()); }
      if(this.resetBtn){ this.resetBtn.addEventListener("click",()=>this.reset()); }
      if(this.speedSelect){ this.speedSelect.addEventListener("change",()=>{ this.playSpeed=this.readSpeed(); if(this.playTimer){ this.restartTimer(); } }); }
      if(this.modeSelect){ this.modeSelect.addEventListener("change",()=>{ this.playMode=this.readMode(); }); }
      if(this.stepSelect){ this.stepSelect.addEventListener("change",()=>{ this.playStep=this.readStep(); }); }
      this.updateDerived(false);
    },
    readSpeed(){
      const v=parseInt(this.speedSelect&&this.speedSelect.value?this.speedSelect.value:500,10);
      return Number.isFinite(v)&&v>0?v:500;
    },
    readMode(){
      const v=this.modeSelect&&this.modeSelect.value?this.modeSelect.value:"grow";
      return v==="slide"?"slide":"grow";
    },
    readStep(){
      const v=parseInt(this.stepSelect&&this.stepSelect.value?this.stepSelect.value:1,10);
      return Number.isFinite(v)&&v>0?v:1;
    },
    update(config){
      if(!this.root){ return; }
      const cfg=config||{};
      const hasBounds=Number.isFinite(cfg.min)&&Number.isFinite(cfg.max)&&cfg.max>=cfg.min;
      const min=hasBounds?Math.round(cfg.min):0;
      const max=hasBounds?Math.round(cfg.max):0;
      const usable=hasBounds;
      const startCandidate=Number.isFinite(cfg.start)?Math.round(cfg.start):(usable?min:0);
      const endCandidate=Number.isFinite(cfg.end)?Math.round(cfg.end):(usable?max:0);
      const wasPlaying=this.isPlaying();
      if(wasPlaying){ this.pause(); }
      this.state.min=usable?min:0;
      this.state.max=usable?max:0;
      this.state.start=usable?clamp(startCandidate,this.state.min,this.state.max):this.state.min;
      this.state.end=usable?clamp(endCandidate,this.state.start,this.state.max):this.state.start;
      if(this.startInput){
        this.startInput.min=String(this.state.min);
        this.startInput.max=String(this.state.max);
        this.startInput.value=String(this.state.start);
        this.startInput.disabled=!usable||this.state.max<=this.state.min;
      }
      if(this.endInput){
        this.endInput.min=String(this.state.min);
        this.endInput.max=String(this.state.max);
        this.endInput.value=String(this.state.end);
        this.endInput.disabled=!usable||this.state.max<=this.state.min;
      }
      if(typeof cfg.getLabel==="function"){ this.getLabel=cfg.getLabel; }
      if(typeof cfg.unitLabel==="string"&&cfg.unitLabel.trim().length){ this.unitLabel=cfg.unitLabel; }
      this.root.classList.toggle("is-disabled",!usable||this.state.max<=this.state.min);
      this.updateDerived(false);
      if(wasPlaying){ this.play(); }
    },
    updateDerived(emit){
      this.updateLabels();
      this.updateSelection();
      if(emit&&this.onChange){ this.onChange({start:this.state.start,end:this.state.end}); }
    },
    updateLabels(){
      if(this.startTitle){ this.startTitle.textContent=`Starting ${this.unitLabel}`; }
      if(this.endTitle){ this.endTitle.textContent=`Ending ${this.unitLabel}`; }
      if(this.startValue){ this.startValue.textContent=this.getLabel(this.state.start); }
      if(this.endValue){ this.endValue.textContent=this.getLabel(this.state.end); }
    },
    updateSelection(){
      if(!this.selectionEl){ return; }
      const span=this.state.max-this.state.min;
      if(!Number.isFinite(span)||span<=0){
        this.selectionEl.style.left="0%";
        this.selectionEl.style.right="100%";
        return;
      }
      const startRatio=(this.state.start-this.state.min)/span;
      const endRatio=(this.state.end-this.state.min)/span;
      this.selectionEl.style.left=`${startRatio*100}%`;
      this.selectionEl.style.right=`${100-endRatio*100}%`;
    },
    setButtons(playVisible){
      if(this.playBtn){ this.playBtn.classList.toggle("hidden",!playVisible); }
      if(this.pauseBtn){ this.pauseBtn.classList.toggle("hidden",playVisible); }
    },
    isPlaying(){
      return !!this.playTimer;
    },
    stepOnce(){
      if(this.state.end>=this.state.max){ this.pause(); return; }
      const nextEnd=clamp(this.state.end+this.playStep,this.state.min,this.state.max);
      if(this.playMode==="slide"){
        const windowSize=Math.max(1,this.state.end-this.state.start);
        const nextStart=clamp(nextEnd-windowSize,this.state.min,nextEnd);
        this.state.start=nextStart;
      }
      this.state.end=nextEnd;
      if(this.startInput){ this.startInput.value=String(this.state.start); }
      if(this.endInput){ this.endInput.value=String(this.state.end); }
      this.updateDerived(true);
      if(this.state.end>=this.state.max){ this.pause(); }
    },
    play(){
      if(this.isPlaying()){ return; }
      if(this.state.end>=this.state.max){ this.state.end=this.state.start; this.updateDerived(true); }
      this.setButtons(false);
      this.playTimer=window.setInterval(()=>this.stepOnce(),this.playSpeed);
    },
    pause(){
      if(!this.isPlaying()){ return; }
      window.clearInterval(this.playTimer);
      this.playTimer=null;
      this.setButtons(true);
    },
    reset(){
      const wasPlaying=this.isPlaying();
      if(wasPlaying){ this.pause(); }
      this.state.end=this.state.start;
      if(this.endInput){ this.endInput.value=String(this.state.end); }
      this.updateDerived(true);
    },
    restartTimer(){
      if(!this.isPlaying()){ return; }
      window.clearInterval(this.playTimer);
      this.playTimer=window.setInterval(()=>this.stepOnce(),this.playSpeed);
    }
  };
  window.RangeSlider=RangeSlider;
})();
</script>
