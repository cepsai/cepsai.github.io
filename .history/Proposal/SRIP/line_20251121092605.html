<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>AI Line Chart – US / EU / China / UK / Rest of world</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #f5f7fb;
    }

    .page {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-rows: 1fr auto auto;
      grid-template-columns: 1fr 1fr;
    }

    #linechartContainer {
      grid-row: 1;
      grid-column: 1 / span 2;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }

    #controlsContainer {
      grid-row: 2;
      grid-column: 1 / span 2;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: clamp(20px, 3vw, 40px);
      padding: clamp(6px, 1.2vh, 10px) 20px;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 -2px 6px rgba(0,0,0,0.05);
    }

    #sourceContainer {
      grid-row: 3;
      grid-column: 1;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0 20px;
      min-height: 40px;
    }

    #logoContainer {
      grid-row: 3;
      grid-column: 2;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 20px;
      min-height: 40px;
    }

    .logo {
      height: 100%;
      width: auto;
      max-height: 100%;
      max-width: 100%;
      object-fit: contain;
    }

    .source-text {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    .source-text a {
      color: #2756d3;
      text-decoration: underline;
    }

    /* Slider + buttons styling reused from your other viz */
    .slider-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
    }
    .slider-label {
      font-size: 18px;
      font-weight: 800;
      color: #4169E1;
      margin-top: 4px;
    }
    .range-wrapper {
      position: relative;
      width: 240px;
      height: 32px;
    }
    .range-wrapper input[type=range] {
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      margin: 0;
      width: 100%;
      -webkit-appearance: none;
      background: transparent;
      pointer-events: none;
    }
    .range-wrapper::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
    }
    .year-slider-top { z-index: 2; }

    .range-wrapper input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #4169E1;
      cursor: pointer;
      pointer-events: auto;
      margin-top: -6px;
    }
    .range-wrapper input[type=range]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #4169E1;
      border: none;
      cursor: pointer;
      pointer-events: auto;
      transform: translateY(-3px);
    }
    .range-wrapper input[type=range]::-moz-range-track {
      background: transparent;
    }

    .button-group {
      display: flex;
      align-items: center;
      gap: 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
      background: #fff;
    }

    .control-btn { padding: clamp(3.6px, 0.6vh, 6px) clamp(7.2px, 1.2vw, 12px); font-size: clamp(6.6px, 0.84vw, 8.4px); font-weight: 600; border: none; background: #ffffff; color: #333; cursor: pointer; transition: all 0.2s ease; }
    /* .control-btn {
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      background: #ffffff;
      color: #333;
      cursor: pointer;
      transition: all 0.2s ease;
    } */
    .control-btn:not(:last-child) {
      border-right: 1px solid #e0e0e0;
    }
    .control-btn:hover:not(.active) {
      background: #f5f5f5;
    }
    .control-btn.active {
      background: #4169E1;
      color: #ffffff;
    }

    /* Chart placeholder */
    #linechart {
      width: 100%;
      max-width: 1100px;
      height: 100%;
      max-height: 520px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    svg {
      font-family: Arial, sans-serif;
    }

    .line-series {
      fill: none;
    }

    .stacked-area {
      stroke: none;
    }

    .legend {
      font-size: 12px;
    }
  </style>
</head>
<body>
<div class="page">

  <div id="linechartContainer">
    <div id="linechart"></div>
  </div>

  <div id="controlsContainer">
    <!-- YEAR RANGE SLIDER -->
    <div class="slider-container">
      <label class="slider-label" id="line-year-label">2000–2025</label>
      <div class="range-wrapper">
        <input type="range" id="line-year-start" min="2000" max="2025" value="2000">
        <input type="range" id="line-year-end"   min="2000" max="2025" value="2025" class="year-slider-top">
      </div>
    </div>

    <!-- METRIC -->
    <div class="button-group" id="line-metric-group">
      <button class="control-btn active" data-metric="investments">INVESTMENTS</button>
      <button class="control-btn" data-metric="patents">PATENTS</button>
      <button class="control-btn" data-metric="publications">PUBLICATIONS</button>
    </div>

    <!-- STACK MODE -->
    <div class="button-group" id="line-stack-group">
      <button class="control-btn active" data-stack="absolute">ABSOLUTE</button>
      <button class="control-btn" data-stack="stacked">RELATIVE</button>
    </div>
  </div>

  <div id="sourceContainer">
    <div class="source-text">
      Source:
      <a id="source-link" href="https://www.crunchbase.com/" target="_blank">Crunchbase</a>
    </div>
  </div>

  <div id="logoContainer">
    <a href="https://aiworld.eu/" target="_blank" rel="noopener">
      <img src="https://aiworld.eu/logo-transparent.svg" class="logo" alt="AI World logo">
    </a>
  </div>

</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
/* ---------------- Metric config (same as your map/treemap) ---------------- */
const metricConfig = {
  investments: {
    label: 'Crunchbase',
    sourceUrl: 'https://www.crunchbase.com/',
    basePathCountry: 'country/crunchbase'
  },
  patents: {
    label: 'RegPat',
    sourceUrl: 'https://www.oecd.org/sti/inno/oecdpatentdatabase.htm',
    basePathCountry: 'country/regpat'
  },
  publications: {
    label: 'OpenAlex',
    sourceUrl: 'https://openalex.org/',
    basePathCountry: 'country/openalex'
  }
};

/* ---------------- EU + macro-region mapping ---------------- */
var euCountryCodes = new Set([
  "AT","BE","BG","HR","CY","CZ","DK","EE","FI","FR",
  "DE","GR","HU","IE","IT","LV","LT","LU","MT","NL",
  "PL","PT","RO","SK","SI","ES","SE"
]);

function getMacroRegionFromGeo(geo) {
  if (!geo) return "Rest of world";
  const m = geo.match(/\(([^)]+)\)\s*$/);
  const code = m ? m[1].trim().toUpperCase() : null;
  if (code === "US") return "US";
  if (code === "CN") return "China";
  if (code === "UK" || code === "GB") return "UK";
  if (code && euCountryCodes.has(code)) return "EU";
  return "Rest of world";
}

/* ---------------- Line chart state ---------------- */
let lineCurrentMetric = "investments";
let lineStackMode = "absolute";  // "absolute" or "stacked"
let lineYearStart = 2000;
let lineYearEnd = 2025;
let lineRawData = []; // [{year, region, value}, ...]

/* ---------------- D3 chart setup ---------------- */
const margin = {top: 30, right: 120, bottom: 40, left: 70};
const outerWidth = 1100;
const outerHeight = 520;
const width = outerWidth - margin.left - margin.right;
const height = outerHeight - margin.top - margin.bottom;

const svg = d3.select("#linechart")
  .append("svg")
  .attr("width", outerWidth)
  .attr("height", outerHeight);

const g = svg.append("g")
  .attr("transform", `translate(${margin.left},${margin.top})`);

const xScale = d3.scaleLinear().range([0, width]);
const yScale = d3.scaleLinear().range([height, 0]);

const xAxisG = g.append("g").attr("transform", `translate(0,${height})`);
const yAxisG = g.append("g");

const colorScale = d3.scaleOrdinal()
  .domain(["US","EU","China","UK","Rest of world",'World'])
  .range(["#ec787a","#f5ae6c","#fadb56","#887aa5","#7a98ad","#000000"]);


const lineGenerator = d3.line()
  .x(d => xScale(d.year))
  .y(d => yScale(d.value))
  .defined(d => d.value != null && !isNaN(d.value));

/* Legend */
const legend = svg.append("g")
  .attr("transform", `translate(${width + margin.left + 10}, ${margin.top})`)
  .attr("class", "legend");

["US","EU","China","UK","Rest of world",'World'].forEach((r, i) => {
  const row = legend.append("g")
    .attr("transform", `translate(0, ${i * 20})`);
  row.append("rect")
    .attr("x", 0)
    .attr("y", -8)
    .attr("width", 12)
    .attr("height", 12)
    .attr("fill", colorScale(r));
  row.append("text")
    .attr("x", 18)
    .attr("y", 0)
    .attr("dominant-baseline", "middle")
    .text(r);
});

/* ---------------- Data loading ---------------- */
async function loadLineDataForMetric(metric) {
  const cfg = metricConfig[metric];
  const startSlider = document.getElementById("line-year-start");
  const endSlider   = document.getElementById("line-year-end");
  const minY = parseInt(startSlider.min, 10);
  const maxY = parseInt(endSlider.max, 10);

  const years = [];
  for (let y = minY; y <= maxY; y++) years.push(y);

  function safeCsv(path) {
    return d3.csv(path).catch(() => []);
  }

  const results = await Promise.all(
    years.map(y =>
      safeCsv(`${cfg.basePathCountry}/${y}.csv`).then(rows => ({year: y, rows}))
    )
  );

  const all = [];

  results.forEach(({year, rows}) => {
    // Filter AI rows, clean values
    const filtered = rows.filter(r => {
      const domain = (r.domain || "").trim().replace(/^"(.*)"$/, "$1");
      const geo = (r.geo || "").trim();
      if (!geo || geo === "nan (NA) (NA)") return false;
      return domain === "Artificial Intelligence";
    });

    const byRegion = d3.rollup(
      filtered,
      v => d3.sum(v, d => +d.count || 0),
      d => getMacroRegionFromGeo((d.geo || "").trim())
    );

    byRegion.forEach((value, region) => {
      all.push({year, region, value});
    });
  });

  lineRawData = all;
  updateLineChart();
}

/* ---------------- Chart rendering ---------------- */
function updateLineChart() {
  const regions = ["US","EU","China","UK","Rest of world",'World'];
  const years = d3.range(lineYearStart, lineYearEnd + 1);

  const perYear = years.map(y => {
    const row = {year: y};
    regions.forEach(r => row[r] = 0);

    lineRawData
      .filter(d => d.year === y)
      .forEach(d => {
        const region = regions.includes(d.region) ? d.region : "Rest of world";
        row[region] += d.value;
      });

    // Add WORLD sum
    row.World = row.US + row.EU + row.China + row.UK + row["Rest of world"];

    return row;
  });

  // wide format per year
  // const perYear = years.map(y => {
  //   const row = {year: y};
  //   regions.forEach(r => row[r] = 0);
  //   lineRawData
  //     .filter(d => d.year === y)
  //     .forEach(d => {
  //       const r = regions.includes(d.region) ? d.region : "Rest of world";
  //       row[r] += d.value;
  //     });
  //   return row;
  // });

  // x domain
  xScale.domain(d3.extent(years));
  xAxisG.call(d3.axisBottom(xScale).tickFormat(d3.format("d")));

  if (lineStackMode === "absolute") {
    // Remove World from stacking (only original regions stack)

    const yMax = d3.max(perYear, d =>
      d.US + d.EU + d.China + d.UK + d["Rest of world"]
    ) || 1;
    yScale.domain([0, yMax]);

    // format y-axis = billions
    yAxisG.call(
      d3.axisLeft(yScale)
        .tickFormat(d => d >= 1e9 ? (d / 1e9).toFixed(1) + "B" : d3.format(",")(d))
    );


    // multiple lines
    const series = regions.map(r => ({
      region: r,
      values: perYear.map(d => ({year: d.year, value: d[r]}))
    }));

    const lines = g.selectAll(".line-series")
      .data(series, d => d.region);

    lines.exit().remove();

    lines.enter()
      .append("path")
      .attr("class", "line-series")
      .merge(lines)
      .attr("stroke-width", 2)
      .attr("stroke", d => colorScale(d.region))
      .attr("fill", "none")
      .attr("d", d => lineGenerator(d.values));

    // remove stacked areas if switching from stacked
    g.selectAll(".stacked-area").remove();

  } else {
    // stacked percentage
    const stackRegions = ["US","EU","China","UK","Rest of world"];
    perYear.forEach(d => {
      const tot = d.US + d.EU + d.China + d.UK + d["Rest of world"];
      if (!tot) return;
      regions.forEach(r => d[r] = d[r] / tot);
    });

    yScale.domain([0, 1]);
    yAxisG.call(d3.axisLeft(yScale).tickFormat(d3.format(".0%")));
    const stack = d3.stack().keys(stackRegions);
    // const stack = d3.stack().keys(regions);
    const stackedData = stack(perYear);

    const area = d3.area()
      .x(d => xScale(d.data.year))
      .y0(d => yScale(d[0]))
      .y1(d => yScale(d[1]));

    const areas = g.selectAll(".stacked-area")
      .data(stackedData, d => d.key);

    areas.exit().remove();

    areas.enter()
      .append("path")
      .attr("class", "stacked-area")
      .merge(areas)
      .attr("fill", d => colorScale(d.key))
      .attr("fill-opacity", 0.6)
      .attr("d", area);

    // remove lines if switching from absolute
    g.selectAll(".line-series").remove();
  }
}

/* ---------------- Controls wiring ---------------- */
const lineStartSlider = document.getElementById("line-year-start");
const lineEndSlider   = document.getElementById("line-year-end");
const lineYearLabel   = document.getElementById("line-year-label");

function updateLineYearLabel() {
  if (lineYearStart === lineYearEnd) {
    lineYearLabel.textContent = lineYearStart;
  } else {
    lineYearLabel.textContent = lineYearStart + "–" + lineYearEnd;
  }
}

lineStartSlider.addEventListener("input", function() {
  if (+this.value > +lineEndSlider.value) this.value = lineEndSlider.value;
  lineYearStart = +this.value;
  updateLineYearLabel();
  updateLineChart();
});

lineEndSlider.addEventListener("input", function() {
  if (+this.value < +lineStartSlider.value) this.value = lineStartSlider.value;
  lineYearEnd = +this.value;
  updateLineYearLabel();
  updateLineChart();
});

document.querySelectorAll("#line-metric-group .control-btn").forEach(btn => {
  btn.addEventListener("click", function() {
    document.querySelectorAll("#line-metric-group .control-btn")
      .forEach(b => b.classList.remove("active"));
    this.classList.add("active");
    lineCurrentMetric = this.dataset.metric;

    const cfg = metricConfig[lineCurrentMetric];
    const srcLink = document.getElementById("source-link");
    srcLink.textContent = cfg.label;
    srcLink.href = cfg.sourceUrl;

    loadLineDataForMetric(lineCurrentMetric);
  });
});

document.querySelectorAll("#line-stack-group .control-btn").forEach(btn => {
  btn.addEventListener("click", function() {
    document.querySelectorAll("#line-stack-group .control-btn")
      .forEach(b => b.classList.remove("active"));
    this.classList.add("active");
    lineStackMode = this.dataset.stack;
    updateLineChart();
  });
});

/* ---------------- Init ---------------- */
updateLineYearLabel();
loadLineDataForMetric(lineCurrentMetric);

</script>
</body>
</html>